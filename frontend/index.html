<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lumica Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            font-family: "Inter", "Segoe UI", system-ui, sans-serif;
            background-color: #030712;
            color: #f4f5f7;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --system-top-reserve: 0px;
            --system-nav-reserve: 0px;
            --app-top-offset: calc(var(--safe-top) + var(--system-top-reserve));
            --app-bottom-offset: calc(var(--safe-bottom) + var(--system-nav-reserve));
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        button,
        [role="button"],
        a {
            -webkit-tap-highlight-color: transparent;
        }

        button:focus:not(:focus-visible),
        [role="button"]:focus:not(:focus-visible),
        a:focus:not(:focus-visible) {
            outline: none;
        }

        html, body {
            height: 100%;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        body {
            margin: 0;
            min-height: 100vh;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            background: radial-gradient(circle at 50% -10%, rgba(99, 140, 255, 0.18), rgba(5, 10, 25, 0.85) 42%), linear-gradient(145deg, #0b1224, #090f1f 55%);
            color: #f4f5f7;
        }

        main {
            width: 100%;
            max-width: 100%;
            min-height: 100vh;
            padding: calc(1.2rem + var(--app-top-offset)) 1rem 1rem;
            overflow-x: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.45s ease, transform 0.45s ease;
        }

        main.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .content {
            width: 100%;
            max-width: 540px;
            margin: 0 auto;
            padding-bottom: calc(110px + var(--app-bottom-offset));
            min-width: 0;
            overflow-x: hidden;
        }
        .app-content,
        .app-shell {
            width: 100%;
            max-width: 100%;
            min-width: 0;
            overflow-x: hidden;
        }

        .status-card,
        .app-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .status-card {
            padding: 1.75rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            align-items: flex-start;
            background: rgba(7, 12, 24, 0.75);
        }

        .app-shell {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.2rem 0.4rem;
            color: #e9ecf5;
            letter-spacing: 0.03em;
            font-weight: 700;
            font-size: 1.05rem;
            text-transform: uppercase;
        }

        .topbar .icon {
            display: none;
        }

        .hero-card {
            position: relative;
            border-radius: 24px;
            overflow: hidden;
            padding: 1.4rem 1.2rem 1.1rem;
            background: radial-gradient(circle at 50% 10%, rgba(92, 174, 255, 0.15), rgba(33, 16, 54, 0.05) 35%, rgba(7, 11, 26, 0.72) 100%);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        }

        .hero-card .orb-hero {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto 0.8rem;
            filter: drop-shadow(0 12px 30px rgba(0,0,0,0.45));
        }

        .hero-icon {
            width: 180px;
            height: 180px;
            display: block;
            margin: 0 auto;
        }

        .hero-caption {
            text-align: center;
            color: #cfe8ff;
            font-weight: 700;
            letter-spacing: 0.02em;
            text-shadow: 0 4px 18px rgba(0,0,0,0.4);
        }

        .hero-sub {
            text-align: center;
            color: rgba(207, 232, 255, 0.8);
            margin-top: 0.15rem;
            font-size: 0.85rem;
        }

        .cards {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .card {
            position: relative;
            padding: 1rem 1rem;
            border-radius: 18px;
            background: linear-gradient(135deg, rgba(28, 46, 74, 0.65), rgba(18, 25, 44, 0.92));
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 14px 40px rgba(0,0,0,0.28);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .card .left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .badge {
            min-width: 32px;
            min-height: 32px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at 30% 30%, #6cf6ff, #1d9bff);
            box-shadow: 0 0 16px rgba(33, 190, 255, 0.45);
            color: #03223b;
            font-weight: 700;
        }

        .card-title {
            color: #eef4ff;
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        .card-sub {
            color: rgba(230, 240, 255, 0.7);
            font-size: 0.92rem;
        }

        .chevron {
            color: rgba(230, 240, 255, 0.7);
        }
        .connection-protocol-btn {
            width: 100%;
            text-align: left;
            font: inherit;
            color: inherit;
            cursor: pointer;
        }
        .connection-protocol-btn:active {
            transform: translateY(1px);
        }
        .connection-pages {
            display: grid;
            gap: 0.8rem;
        }
        .connections-detail-list {
            display: grid;
            gap: 0.55rem;
        }
        .connections-detail-info {
            border: 1px solid rgba(133, 188, 255, 0.34);
            border-radius: 12px;
            background: rgba(23, 38, 66, 0.62);
            color: #e5f1ff;
            padding: 0.62rem 0.72rem;
            font-size: 0.82rem;
            line-height: 1.35;
            white-space: pre-wrap;
            overflow-wrap: anywhere;
        }
        .connection-item {
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            background: rgba(11, 18, 34, 0.82);
            padding: 0.64rem 0.72rem;
        }
        .connection-item-title {
            color: #edf6ff;
            font-weight: 700;
            font-size: 0.84rem;
            line-height: 1.25;
        }
        .connection-item-meta {
            margin-top: 0.2rem;
            display: grid;
            gap: 0.1rem;
            color: rgba(219, 234, 255, 0.74);
            font-size: 0.78rem;
            line-height: 1.35;
        }
        .connection-copy-row {
            margin-top: 0.45rem;
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }
        .connection-copy-btn {
            border: 1px solid rgba(120, 171, 255, 0.42);
            background: rgba(28, 44, 80, 0.9);
            color: #edf6ff;
            border-radius: 8px;
            padding: 0.3rem 0.52rem;
            font-size: 0.76rem;
            font-weight: 700;
            cursor: pointer;
        }
        .connection-copy-btn:active {
            transform: translateY(1px);
        }

        .section-title {
            margin: 0.2rem 0 0.3rem;
            color: #e6ecf7;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .pill-soft {
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(79, 123, 255, 0.28), rgba(95, 237, 255, 0.22));
            color: #dce9ff;
            font-size: 0.9rem;
            border: 1px solid rgba(255,255,255,0.08);
        }

        .support-card {
            text-align: center;
            font-weight: 700;
        }

        .bottom-nav {
            position: fixed;
            left: max(0.5rem, env(safe-area-inset-left, 0px));
            right: max(0.5rem, env(safe-area-inset-right, 0px));
            bottom: calc(16px + var(--app-bottom-offset));
            width: auto;
            max-width: 560px;
            margin-inline: auto;
            padding: 0.35rem;
            border-radius: 16px;
            background: rgba(12, 18, 33, 0.92);
            border: 1px solid rgba(255, 255, 255, 0.06);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.25rem;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(12px);
        }
        .bottom-nav.with-work {
            grid-template-columns: repeat(5, 1fr);
        }

        .nav-btn {
            border: none;
            background: transparent;
            color: rgba(220, 232, 255, 0.8);
            padding: 0.65rem 0.4rem;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            align-items: center;
            font-size: 0.92rem;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease, transform 0.15s;
        }

        .nav-btn .icon {
            font-size: 1.05rem;
        }
        .nav-btn span:last-child {
            font-size: 0.84rem;
            line-height: 1.12;
            white-space: nowrap;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, rgba(64, 224, 255, 0.2), rgba(122, 89, 255, 0.2));
            color: #f5fbff;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08), 0 6px 16px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }

        .screen {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            width: 100%;
            min-width: 0;
            max-width: 100%;
            overflow-x: hidden;
        }
        #screen-work {
            width: 100vw;
            margin-left: calc(50% - 50vw);
            margin-right: calc(50% - 50vw);
            padding-inline: 1rem;
            --context-popup-offset: -1.6rem;
            box-sizing: border-box;
            align-items: stretch;
        }
        #screen-connections {
            width: 100vw;
            margin-left: calc(50% - 50vw);
            margin-right: calc(50% - 50vw);
            padding-inline: 1rem;
            padding-top: 0.6rem;
            --context-popup-offset: -2.8rem;
            box-sizing: border-box;
            align-items: stretch;
        }
        #screen-cloud {
            width: 100%;
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
            padding-inline: 0;
            padding-top: 0.6rem;
            --context-popup-offset: -2.8rem;
            box-sizing: border-box;
            align-items: stretch;
            overflow-x: hidden;
        }
        .work-page {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 0.9rem;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(13, 18, 31, 0.78);
        }
        #work-menu-page {
            width: 100%;
            padding: 0;
            border: none;
            background: transparent;
        }
        #screen-work .section-title {
            width: 100%;
        }
        .work-page-title {
            color: #eaf2ff;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.01em;
        }
        .work-page-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.6rem;
        }
        #screen-work .work-page-head .work-page-title {
            display: none;
        }
        #screen-connections .work-page-head .work-page-title {
            display: none;
        }
        .work-page-context {
            display: flex;
            justify-content: center;
            position: relative;
            z-index: 4;
            margin-top: var(--context-popup-offset, -2.8rem);
            margin-bottom: 0.35rem;
        }
        .work-page-context.hidden {
            display: none;
        }
        .work-page-pill {
            position: relative;
            display: inline-block;
            max-width: clamp(8rem, 56vw, 18rem);
            padding: 0.34rem 0.78rem 0.34rem 1.34rem;
            border-radius: 999px;
            border: 1px solid rgba(155, 206, 255, 0.45);
            background: rgba(17, 30, 56, 0.92);
            box-shadow: 0 8px 20px rgba(4, 10, 24, 0.45), inset 0 0 0 1px rgba(255, 255, 255, 0.04);
            color: #ebf4ff;
            font-size: 0.82rem;
            font-weight: 700;
            letter-spacing: 0.01em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            pointer-events: none;
            z-index: 0;
        }
        .work-page-pill::before {
            content: "";
            position: absolute;
            left: 0.56rem;
            top: 50%;
            width: 0.44rem;
            height: 0.44rem;
            border-radius: 999px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #8be7ff, #7d8cff);
            box-shadow: 0 0 10px rgba(125, 140, 255, 0.5);
        }
        .work-back-btn {
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(18, 26, 44, 0.92);
            color: #dbe9ff;
            border-radius: 10px;
            padding: 0.45rem 0.65rem;
            cursor: pointer;
            font-weight: 700;
        }
        .work-profile-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.8rem;
            width: 100%;
            padding: 0.9rem;
            border-radius: 16px;
            background: rgba(14, 20, 34, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .work-profile-main {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 0;
        }
        .work-profile-avatar {
            width: 54px;
            height: 54px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.35rem;
            background: radial-gradient(circle at 30% 30%, rgba(255, 164, 117, 0.28), rgba(35, 42, 60, 0.9));
            flex: 0 0 54px;
        }
        .work-profile-name {
            color: #f3f8ff;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .work-profile-role {
            margin-top: 0.18rem;
            color: rgba(224, 236, 255, 0.72);
            font-size: 0.84rem;
        }
        .work-menu-groups {
            display: grid;
            width: 100%;
            grid-template-columns: minmax(0, 1fr);
            gap: 0.75rem;
            margin-top: 0.75rem;
        }
        .work-menu-group {
            width: 100%;
            padding: 0.85rem;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.7);
            background: rgba(15, 20, 34, 0.86);
        }
        .work-menu-group-title {
            color: #f4f8ff;
            font-size: 1.05rem;
            font-weight: 700;
            margin-bottom: 0.65rem;
        }
        .work-menu-buttons {
            display: grid;
            gap: 0.6rem;
        }
        .work-menu-btn {
            width: 100%;
            border: 1px solid rgba(120, 171, 255, 0.42);
            background: linear-gradient(135deg, rgba(34, 50, 88, 0.92), rgba(18, 29, 56, 0.96));
            color: #f2f8ff;
            border-radius: 12px;
            padding: 0.8rem 0.75rem;
            text-align: center;
            font-weight: 700;
            cursor: pointer;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.04), 0 8px 18px rgba(7, 16, 35, 0.34);
            transition: transform 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
        }
        .work-menu-btn:active {
            transform: translateY(1px);
            border-color: rgba(132, 227, 255, 0.72);
            box-shadow: inset 0 0 0 1px rgba(186, 236, 255, 0.1), 0 6px 14px rgba(8, 17, 38, 0.32);
        }
        .work-menu-btn:focus-visible {
            outline: none;
            border-color: rgba(132, 227, 255, 0.78);
            box-shadow: 0 0 0 2px rgba(86, 184, 255, 0.22), inset 0 0 0 1px rgba(186, 236, 255, 0.12);
        }
        .work-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.6rem;
        }
        .work-action-link {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.7rem;
            border: 1px solid rgba(142, 198, 255, 0.52);
            background: linear-gradient(135deg, rgba(38, 61, 106, 0.94), rgba(18, 33, 66, 0.98));
            border-radius: 12px;
            padding: 0.78rem 0.82rem;
            cursor: pointer;
            color: #f2f8ff;
            font-weight: 700;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.06), 0 10px 22px rgba(7, 15, 35, 0.35);
            transition: transform 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
        }
        .work-action-link:active {
            transform: translateY(1px);
            border-color: rgba(132, 227, 255, 0.76);
            box-shadow: inset 0 0 0 1px rgba(186, 236, 255, 0.12), 0 7px 16px rgba(8, 17, 38, 0.3);
        }
        .work-action-link:focus-visible {
            outline: none;
            border-color: rgba(132, 227, 255, 0.82);
            box-shadow: 0 0 0 2px rgba(86, 184, 255, 0.24), inset 0 0 0 1px rgba(186, 236, 255, 0.14);
        }
        .work-action-link-label {
            color: #f4f9ff;
            font-size: 0.94rem;
            line-height: 1.2;
        }
        .work-action-link-chevron {
            color: rgba(204, 230, 255, 0.9);
            font-size: 1.08rem;
            line-height: 1;
            font-weight: 800;
            flex: 0 0 auto;
        }
        .work-btn {
            border: 1px solid rgba(120, 171, 255, 0.36);
            background: linear-gradient(135deg, rgba(30, 47, 84, 0.9), rgba(16, 27, 52, 0.95));
            color: #f4f8ff;
            border-radius: 12px;
            padding: 0.75rem 0.7rem;
            cursor: pointer;
            font-weight: 700;
            text-align: left;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.035), 0 8px 16px rgba(7, 15, 34, 0.3);
            transition: transform 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
        }
        .work-btn:active {
            transform: translateY(1px);
            border-color: rgba(132, 227, 255, 0.68);
            box-shadow: inset 0 0 0 1px rgba(186, 236, 255, 0.1), 0 6px 12px rgba(8, 17, 38, 0.28);
        }
        .work-btn:focus-visible {
            outline: none;
            border-color: rgba(132, 227, 255, 0.76);
            box-shadow: 0 0 0 2px rgba(86, 184, 255, 0.2), inset 0 0 0 1px rgba(186, 236, 255, 0.12);
        }
        .work-note {
            font-size: 0.82rem;
            color: rgba(221, 235, 255, 0.72);
            line-height: 1.35;
        }
        .work-client-summary-card {
            padding: 0.85rem 0.95rem;
        }
        .work-client-summary {
            display: grid;
            gap: 0.62rem;
        }
        .work-client-summary-row {
            display: grid;
            gap: 0.14rem;
        }
        .work-client-summary-label {
            color: rgba(192, 215, 255, 0.76);
            font-size: 0.79rem;
        }
        .work-client-summary-value {
            color: #edf6ff;
            font-weight: 700;
            font-size: 0.88rem;
        }
        .work-bind input {
            width: 100%;
            background: rgba(12, 20, 38, 0.9);
            color: #e9f2ff;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            padding: 0.55rem 0.6rem;
        }
        .work-sub-extend-wrap {
            width: 100%;
            display: grid;
            gap: 0.42rem;
        }
        .work-sub-extend-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
        }
        .work-sub-extend-label {
            color: rgba(207, 226, 255, 0.8);
            font-size: 0.82rem;
        }
        .work-sub-extend-value {
            color: #eef7ff;
            font-size: 0.86rem;
            font-weight: 700;
        }
        .work-sub-extend-range {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 1.5rem;
            margin: 0;
            padding: 0;
            border: none;
            background: transparent;
            touch-action: pan-y;
            --work-sub-progress: 0%;
        }
        .work-sub-extend-range:focus {
            outline: none;
        }
        .work-sub-extend-range::-webkit-slider-runnable-track {
            height: 0.38rem;
            border-radius: 999px;
            background: linear-gradient(
                90deg,
                #56b8ff 0%,
                #56b8ff var(--work-sub-progress),
                rgba(192, 216, 255, 0.28) var(--work-sub-progress),
                rgba(192, 216, 255, 0.28) 100%
            );
        }
        .work-sub-extend-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 1.02rem;
            height: 1.02rem;
            margin-top: -0.32rem;
            border-radius: 50%;
            border: 2px solid #56b8ff;
            background: #f3f9ff;
            box-shadow: 0 2px 8px rgba(7, 17, 34, 0.45);
            cursor: pointer;
        }
        .work-sub-extend-range::-moz-range-track {
            height: 0.38rem;
            border: none;
            border-radius: 999px;
            background: rgba(192, 216, 255, 0.28);
        }
        .work-sub-extend-range::-moz-range-progress {
            height: 0.38rem;
            border: none;
            border-radius: 999px;
            background: #56b8ff;
        }
        .work-sub-extend-range::-moz-range-thumb {
            width: 1.02rem;
            height: 1.02rem;
            border-radius: 50%;
            border: 2px solid #56b8ff;
            background: #f3f9ff;
            box-shadow: 0 2px 8px rgba(7, 17, 34, 0.45);
            cursor: pointer;
        }
        .work-sub-create-wrap {
            width: 100%;
            display: grid;
            gap: 0.42rem;
        }
        .work-sub-create-label {
            color: rgba(207, 226, 255, 0.8);
            font-size: 0.82rem;
        }
        .work-sub-create-input {
            color-scheme: dark;
        }
        .work-bind {
            display: grid;
            gap: 0.6rem;
            margin-top: 0.35rem;
        }
        .work-bind select {
            width: 100%;
            background: rgba(12, 20, 38, 0.9);
            color: #e9f2ff;
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px;
            padding: 0.55rem 0.6rem;
        }
        .work-bind-actions {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.55rem;
        }
        @media (max-width: 420px) {
            .work-bind-actions {
                grid-template-columns: 1fr;
            }
        }
        .work-client-cards,
        .work-links-list {
            display: grid;
            gap: 0.6rem;
        }
        .work-client-card {
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(23, 35, 62, 0.88), rgba(14, 20, 38, 0.95));
            color: #eef5ff;
            border-radius: 12px;
            padding: 0.8rem;
            cursor: pointer;
            text-align: left;
        }
        .work-client-card-title {
            font-weight: 700;
            color: #f3f7ff;
        }
        .work-client-card-sub {
            margin-top: 0.2rem;
            color: rgba(221, 235, 255, 0.72);
            font-size: 0.84rem;
        }
        .work-link-item {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.7rem;
            background: rgba(12, 19, 36, 0.86);
        }
        .work-link-item-title {
            color: #eff5ff;
            font-weight: 700;
            font-size: 0.9rem;
        }
        .work-link-item-value {
            margin-top: 0.24rem;
            color: #f5f9ff;
            font-size: 0.85rem;
            line-height: 1.35;
        }
        .work-link-item-sub {
            margin-top: 0.2rem;
            color: rgba(219, 234, 255, 0.72);
            font-size: 0.82rem;
            line-height: 1.35;
        }
        .work-link-clients {
            margin-top: 0.45rem;
            display: grid;
            gap: 0.35rem;
        }
        .work-link-client {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 0.48rem 0.55rem;
            background: rgba(16, 25, 46, 0.84);
        }
        .work-link-client-name {
            color: #eef6ff;
            font-size: 0.83rem;
            line-height: 1.3;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .work-link-client-remove {
            border: 1px solid rgba(255, 107, 107, 0.5);
            background: rgba(120, 25, 37, 0.42);
            color: #ffd7dc;
            border-radius: 8px;
            padding: 0.2rem 0.5rem;
            font-size: 0.78rem;
            font-weight: 700;
            cursor: pointer;
            flex: 0 0 auto;
        }
        .work-link-client-remove:active {
            transform: translateY(1px);
        }
        .work-inbounds-list {
            display: grid;
            gap: 0.55rem;
        }
        .work-inbound-card {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(12, 19, 36, 0.86);
            padding: 0.75rem;
            display: grid;
            gap: 0.45rem;
        }
        .work-inbound-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.6rem;
            flex-wrap: wrap;
        }
        .work-inbound-title {
            color: #eff6ff;
            font-weight: 700;
            font-size: 0.9rem;
            line-height: 1.25;
        }
        .work-inbound-meta {
            color: rgba(219, 234, 255, 0.74);
            font-size: 0.82rem;
            line-height: 1.3;
        }
        .work-inbound-badges {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            flex-wrap: wrap;
        }
        .work-inbound-pill {
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 999px;
            padding: 0.16rem 0.48rem;
            font-size: 0.75rem;
            color: #e7f1ff;
            background: rgba(28, 41, 68, 0.86);
        }
        .work-inbound-pill.off {
            border-color: rgba(255, 126, 126, 0.35);
            background: rgba(86, 20, 20, 0.36);
            color: #ffd3d3;
        }
        .work-inbound-toggle-btn {
            border: 1px solid rgba(126, 189, 255, 0.42);
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(34, 50, 88, 0.92), rgba(18, 29, 56, 0.96));
            color: #f2f8ff;
            padding: 0.48rem 0.6rem;
            font-size: 0.81rem;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
        }
        .work-inbound-toggle-btn:active {
            transform: translateY(1px);
        }
        .cloud-page {
            display: grid;
            width: 100%;
            max-width: 100%;
            gap: 0.68rem;
            padding: 0.85rem;
            min-width: 0;
            overflow-x: hidden;
        }
        .cloud-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.55rem;
            flex-wrap: wrap;
        }
        .cloud-path {
            border: 1px solid rgba(126, 189, 255, 0.34);
            border-radius: 10px;
            background: rgba(17, 28, 50, 0.72);
            color: #ecf6ff;
            font-size: 0.82rem;
            line-height: 1.35;
            padding: 0.48rem 0.58rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cloud-actions {
            display: grid;
            gap: 0.55rem;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            min-width: 0;
            max-width: 100%;
        }
        .cloud-upload-btn {
            display: block;
            width: 100%;
            text-align: center;
            max-width: 100%;
            min-width: 0;
        }
        .cloud-upload-btn.disabled {
            opacity: 0.58;
            pointer-events: none;
        }
        .cloud-upload-progress {
            position: relative;
            width: 100%;
            height: 0.42rem;
            border-radius: 999px;
            border: 1px solid rgba(132, 185, 255, 0.28);
            background: rgba(19, 30, 52, 0.75);
            overflow: hidden;
        }
        .cloud-upload-progress-bar {
            width: 0%;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, #56b8ff, #7bdcff);
            box-shadow: 0 0 10px rgba(86, 184, 255, 0.35);
            transition: width 0.16s ease;
        }
        .cloud-upload-progress-text {
            font-size: 0.76rem;
            line-height: 1.2;
            color: rgba(212, 232, 255, 0.82);
            margin-top: -0.12rem;
        }
        .cloud-list {
            display: grid;
            gap: 0.54rem;
            width: 100%;
            max-width: 100%;
            min-width: 0;
        }
        .cloud-node-card {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: rgba(12, 19, 36, 0.88);
            padding: 0.62rem 0.68rem;
            display: grid;
            gap: 0.48rem;
        }
        .cloud-node-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.52rem;
            min-width: 0;
            max-width: 100%;
        }
        .cloud-node-open {
            border: none;
            background: transparent;
            color: #eef6ff;
            font-weight: 700;
            font-size: 0.86rem;
            line-height: 1.3;
            padding: 0;
            margin: 0;
            cursor: pointer;
            min-width: 0;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cloud-node-open:active {
            transform: translateY(1px);
        }
        .cloud-node-sub {
            color: rgba(219, 234, 255, 0.75);
            font-size: 0.79rem;
            line-height: 1.34;
            overflow-wrap: anywhere;
        }
        .cloud-node-actions {
            display: flex;
            align-items: center;
            gap: 0.42rem;
            flex-wrap: wrap;
            min-width: 0;
            max-width: 100%;
        }
        .cloud-node-action {
            border: 1px solid rgba(120, 171, 255, 0.42);
            background: rgba(28, 44, 80, 0.9);
            color: #edf6ff;
            border-radius: 8px;
            padding: 0.26rem 0.5rem;
            font-size: 0.76rem;
            font-weight: 700;
            cursor: pointer;
        }
        .cloud-node-action.danger {
            border-color: rgba(255, 126, 126, 0.45);
            background: rgba(86, 20, 20, 0.36);
            color: #ffd3d3;
        }
        .cloud-node-action:disabled {
            opacity: 0.56;
            cursor: default;
        }
        .cloud-status-note {
            font-size: 0.8rem;
            line-height: 1.34;
            color: rgba(212, 232, 255, 0.78);
            min-height: 1.08rem;
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        .cloud-status-note.error {
            color: #ffd0d8;
        }
        .cloud-status-note.success {
            color: #bafcd7;
        }
        @media (max-width: 420px) {
            .cloud-actions {
                grid-template-columns: 1fr;
            }
        }
        .work-empty {
            border: 1px dashed rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 0.75rem;
            color: rgba(219, 234, 255, 0.72);
            font-size: 0.86rem;
        }
        .work-stub {
            min-height: 140px;
            display: flex;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: clamp(1.75rem, 3vw, 2.25rem);
            line-height: 1.2;
        }

        p {
            margin: 0;
            line-height: 1.5;
            color: rgba(244, 245, 247, 0.85);
        }

        .app-content.hidden {
            display: none;
        }

        .status-card.hidden {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.35rem 0.9rem;
            border-radius: 999px;
            font-size: 0.8rem;
            letter-spacing: 0.02em;
            text-transform: uppercase;
            color: #0a0f1a;
            background: linear-gradient(135deg, #facc15, #f97316);
            align-self: flex-start;
        }

        .cta {
            margin-top: 1.25rem;
            padding: 0.85rem 1.2rem;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #38bdf8, #6366f1);
            color: #fff;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .cta:disabled {
            opacity: 0.5;
            cursor: wait;
        }

        .cta:not(:disabled):hover {
            transform: translateY(-1px);
        }

        /* === Breathing orb scene === */
        .pulse-scene {
            --glow-color: rgba(55, 224, 255, 0.55);
            --cycle: 4.8s; /* —É–¥–ª–∏–Ω–∏–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (–±—ã–ª–æ 2.4s) */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.1rem;
            width: 100%;
        }

        .orb-wrapper {
            position: relative;
            width: min(190px, 46vw);
            aspect-ratio: 1;
            transform-origin: 50% 50%;
        }

        .orb {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background:
                /* soft cyan base */
                radial-gradient(120% 120% at 22% 30%, rgba(80, 248, 255, 0.92), rgba(30, 38, 78, 0.0) 55%),
                /* deeper blue body */
                radial-gradient(110% 110% at 40% 55%, rgba(52, 129, 255, 0.85), rgba(12, 19, 40, 0.0) 70%),
                /* violet limb */
                radial-gradient(100% 100% at 78% 58%, rgba(158, 83, 255, 0.9), rgba(17, 16, 39, 0.0) 58%),
                /* subtle base tint */
                linear-gradient(135deg, #37e0ff 0%, #4f7bff 48%, #a855f7 100%);
            background-size: 150% 150%;
            animation:
                breathe var(--cycle) ease-in-out infinite,
                gradientShift 8s ease-in-out infinite alternate;
            box-shadow:
                0 0 28px 8px rgba(55, 224, 255, 0.18),
                0 0 64px 18px var(--glow-color),
                0 0 22px 6px rgba(148, 68, 255, 0.25);
            filter: drop-shadow(0 12px 28px rgba(0,0,0,0.35));
        }

        /* Crescent overlay for the 'slice' like in the icon */
        .orb::before {
            content: "";
            position: absolute;
            inset: -6%;
            border-radius: 50%;
            background: radial-gradient(85% 85% at 78% 42%, rgba(12, 17, 34, 0.78), rgba(12,17,34,0) 50%);
            mix-blend-mode: multiply;
            animation: breathe var(--cycle) ease-in-out infinite;
        }

        .orb::after {
            content: "";
            position: absolute;
            inset: -18%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--glow-color) 0%, rgba(59, 123, 255, 0) 65%);
            filter: blur(18px);
            opacity: 0.7;
            animation: glowBreath var(--cycle) ease-in-out infinite;
        }

        .orb-highlight {
            position: absolute;
            inset: 14%;
            border-radius: 50%;
            background: radial-gradient(circle at 28% 28%, rgba(255,255,255,0.18), rgba(255,255,255,0));
            mix-blend-mode: screen;
            opacity: 0.12;
            animation: highlightBreath var(--cycle) ease-in-out infinite;
        }

        .status-label {
            font-size: 1.05rem;
            letter-spacing: 0.01em;
            color: rgba(244, 245, 247, 0.9);
            transition: opacity 150ms ease;
        }

        .status-label.fade-out {
            opacity: 0;
        }

        @keyframes breathe {
            0%   { transform: scale(1.00); }
            25%  { transform: scale(1.03); }
            50%  { transform: scale(1.06); }
            75%  { transform: scale(1.03); }
            100% { transform: scale(1.00); }
        }

        @keyframes glowBreath {
            0%   { opacity: 0.45; filter: blur(16px); }
            25%  { opacity: 0.58; filter: blur(18px); }
            50%  { opacity: 0.75; filter: blur(22px); }
            75%  { opacity: 0.62; filter: blur(18px); }
            100% { opacity: 0.45; filter: blur(16px); }
        }

        @keyframes highlightBreath {
            0%   { transform: scale(1.00); opacity: 0.10; }
            50%  { transform: scale(1.02); opacity: 0.15; }
            100% { transform: scale(1.00); opacity: 0.10; }
        }

        @keyframes gradientShift {
            0%   { background-position: 40% 40%; }
            100% { background-position: 60% 60%; }
        }

        /* Fullscreen loading stage */
        #loading {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0b1b45, #111b36 60%);
            z-index: 5;
        }

        /* Exit transition */
        #loading.exiting {
            animation: fadeOutBg 0.7s ease forwards;
        }

        .orb-wrapper.expand {
            animation: orbExpand 0.7s ease forwards;
        }

        @keyframes orbExpand {
            0% { transform: scale(1); opacity: 1; }
            70% { transform: scale(12); opacity: 0.35; }
            100% { transform: scale(18); opacity: 0; }
        }

        @keyframes fadeOutBg {
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="pulse-scene" id="pulse-scene">
            <div class="orb-wrapper">
                <div class="orb"></div>
                <div class="orb-highlight"></div>
            </div>
            <div class="status-label" id="status-label">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä‚Ä¶</div>
        </div>
    </div>

    <main class="hidden">
        <section id="status-card" class="status-card hidden">
            <h1 id="status-title">–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç</h1>
            <p id="status-text">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>
        </section>

        <section id="app-content" class="app-content hidden">
            <div class="content">
            <div class="app-shell">
                <div class="topbar" id="topbar">
                    <div class="brand">Lumica Service</div>
                </div>

                <div class="hero-card" id="hero-card">
                    <div class="orb-hero">
                        <img class="hero-icon" alt="Lumica orb" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><defs><radialGradient id='g1' cx='30%' cy='30%' r='80%'><stop offset='0%' stop-color='%234ef0ff'/><stop offset='65%' stop-color='%232b5be0'/><stop offset='100%' stop-color='%231a1f3f' stop-opacity='0.05'/></radialGradient><radialGradient id='g2' cx='75%' cy='60%' r='55%'><stop offset='0%' stop-color='%23a060ff' stop-opacity='0.95'/><stop offset='100%' stop-color='%23101020' stop-opacity='0'/></radialGradient></defs><circle cx='100' cy='100' r='95' fill='url(%23g1)'/><circle cx='100' cy='100' r='95' fill='url(%23g2)'/><circle cx='120' cy='70' r='78' fill='rgba(10,15,40,0.45)'/></svg>" />
                    </div>
                    <div class="hero-caption" id="welcome-title">Lumica Service</div>
                    <div class="hero-sub" id="hero-sub">–°–µ—Ä–≤–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω ‚Ä¢ –û–Ω–ª–∞–π–Ω</div>
                </div>

                    <div id="screen-home" class="screen">
                        <div class="cards">
                            <div class="card">
                                <div class="left">
                                    <div class="badge">‚úì</div>
                                    <div>
                                        <div class="card-title">–°–µ—Ä–≤–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω</div>
                                        <div class="card-sub" id="home-server-sub">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                                    </div>
                                </div>
                                <span class="chevron"></span>
                            </div>
                            <div class="card">
                                <div class="left">
                                    <div class="badge">‚óé</div>
                                    <div>
                                        <div class="card-title" id="home-sub-title">–ü–æ–¥–ø–∏—Å–∫–∞</div>
                                        <div class="card-sub" id="home-sub-sub">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                                    </div>
                                </div>
                                <span class="card-sub" id="home-sub-right">...</span>
                            </div>
                        </div>
                    </div>

                    <div id="screen-connections" class="screen hidden">
                        <div class="work-page-context hidden" id="connections-page-context">
                            <div class="work-page-pill" id="connections-page-context-pill" aria-live="polite">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                        </div>
                        <div class="connection-pages">
                            <section id="connections-menu-page">
                                <div class="cards">
                                    <button type="button" class="card connection-protocol-btn" id="vless-card" data-connection-protocol="vless">
                                        <div class="left">
                                            <div class="badge">V</div>
                                            <div>
                                                <div class="card-title">VLESS</div>
                                                <div class="card-sub" id="vless-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                                            </div>
                                        </div>
                                        <span class="chevron" id="vless-detail">‚Ä∫</span>
                                    </button>
                                    <button type="button" class="card connection-protocol-btn" id="http-card" data-connection-protocol="http">
                                        <div class="left">
                                            <div class="badge">H</div>
                                            <div>
                                                <div class="card-title">HTTP Proxy</div>
                                                <div class="card-sub" id="http-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                                            </div>
                                        </div>
                                        <span class="chevron" id="http-detail">‚Ä∫</span>
                                    </button>
                                    <button type="button" class="card connection-protocol-btn" id="mixed-card" data-connection-protocol="mixed">
                                        <div class="left">
                                            <div class="badge">M</div>
                                            <div>
                                                <div class="card-title">Mixed (SOCKS5)</div>
                                                <div class="card-sub" id="mixed-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                                            </div>
                                        </div>
                                        <span class="chevron" id="mixed-detail">‚Ä∫</span>
                                    </button>
                                    <div id="connections-hidden-note" class="work-empty hidden">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</div>
                                </div>
                            </section>

                            <section id="connections-detail-page" class="hidden">
                                <div class="work-page-head">
                                    <button type="button" class="work-back-btn" id="connections-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
                                    <div class="work-page-title" id="connections-detail-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                                </div>
                                <div class="connections-detail-info" id="connections-detail-subtitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è—Ö</div>
                                <div id="connections-detail-list" class="connections-detail-list">
                                    <div class="work-empty">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>
                                </div>
                            </section>
                        </div>
                    </div>

                    <div id="screen-work" class="screen hidden">
                        <div class="section-title" id="work-section-title">–†–∞–±–æ—Ç–∞</div>
                        <div class="work-page-context hidden" id="work-page-context">
                            <div class="work-page-pill" id="work-page-context-pill" aria-live="polite">–†–∞–±–æ—Ç–∞</div>
                        </div>

                        <section id="work-menu-page" class="work-page">
                            <div class="work-profile-card" id="work-header-card">
                                <div class="work-profile-main">
                                    <div class="work-profile-avatar">üë§</div>
                                    <div>
                                        <div class="work-profile-name" id="work-owner-name">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
                                        <div class="work-profile-role" id="work-owner-role">user</div>
                                    </div>
                                </div>
                                <span class="pill-soft hidden" id="work-role-pill" aria-hidden="true"></span>
                            </div>

                            <div class="work-menu-groups">
                                <section class="work-menu-group">
                                    <div class="work-menu-group-title">–†–∞–±–æ—Ç–∞ —Å –ª—é–¥—å–º–∏</div>
                                    <div class="work-menu-buttons">
                                        <button type="button" class="work-menu-btn" data-work-nav="work-staff-page">–ü–µ—Ä—Å–æ–Ω–∞–ª</button>
                                        <button type="button" class="work-menu-btn" data-work-nav="work-clients-page">–ö–ª–∏–µ–Ω—Ç—ã</button>
                                    </div>
                                </section>
                                <section class="work-menu-group">
                                    <div class="work-menu-group-title">–†–∞–±–æ—Ç–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏</div>
                                    <div class="work-menu-buttons">
                                        <button type="button" class="work-menu-btn" data-work-nav="work-inbounds-page">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
                                    </div>
                                </section>
                            </div>
                        </section>

                        <section id="work-staff-page" class="work-page hidden">
                            <div class="work-page-head">
                                <button class="work-back-btn" data-work-back="work-menu-page">‚Üê –ù–∞–∑–∞–¥</button>
                                <div class="work-page-title">–ü–µ—Ä—Å–æ–Ω–∞–ª</div>
                            </div>
                            <div class="work-empty work-stub">–≠–∫—Ä–∞–Ω –ø–µ—Ä—Å–æ–Ω–∞–ª–∞. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Ä–æ–ª–∏.</div>
                        </section>

                        <section id="work-clients-page" class="work-page hidden">
                            <div class="work-page-head">
                                <button class="work-back-btn" data-work-back="work-menu-page">‚Üê –ù–∞–∑–∞–¥</button>
                                <div class="work-page-title">–ö–ª–∏–µ–Ω—Ç—ã</div>
                                <button id="work-refresh-users-btn" class="work-back-btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
                            </div>
                            <div id="work-client-cards" class="work-client-cards">
                                <div class="work-empty">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</div>
                            </div>
                            <div class="work-actions">
                                <button type="button" class="work-action-link" data-work-nav="work-pending-page">
                                    <span class="work-action-link-label">Pending –¥–æ –≤—Ö–æ–¥–∞</span>
                                    <span class="work-action-link-chevron" aria-hidden="true">‚Ä∫</span>
                                </button>
                            </div>
                        </section>

                        <section id="work-pending-page" class="work-page hidden">
                            <div class="work-page-head">
                                <button class="work-back-btn" data-work-back="work-clients-page">‚Üê –ù–∞–∑–∞–¥</button>
                                <div class="work-page-title">Pending –¥–æ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞</div>
                            </div>
                            <div class="work-bind">
                                <input id="work-pending-telegram-id" type="text" inputmode="numeric" placeholder="Telegram ID">
                                <select id="work-pending-inbound-select">
                                    <option value="">–í—ã–±–µ—Ä–∏ inbound</option>
                                </select>
                                <select id="work-pending-client-select">
                                    <option value="">–í—ã–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ inbound</option>
                                </select>
                                <button id="work-pending-add-btn" class="work-btn">–î–æ–±–∞–≤–∏—Ç—å pending-–ø—Ä–∏–≤—è–∑–∫—É</button>
                                <div class="work-note">–≠—Ç–æ—Ç inbound –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</div>
                            </div>
                            <div id="work-pending-list" class="work-links-list">
                                <div class="work-empty">Pending-–ø—Ä–∏–≤—è–∑–∫–∏ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
                            </div>
                        </section>

                        <section id="work-inbounds-page" class="work-page hidden">
                            <div class="work-page-head">
                                <button class="work-back-btn" data-work-back="work-menu-page">‚Üê –ù–∞–∑–∞–¥</button>
                                <div class="work-page-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                                <button id="work-sync-inbounds-btn" class="work-back-btn">–°–∏–Ω—Ö—Ä.</button>
                            </div>
                            <div class="work-note">–£–ø—Ä–∞–≤–ª—è–π, –∫–∞–∫–∏–µ inbound –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤–æ –≤–∫–ª–∞–¥–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.</div>
                            <div id="work-inbounds-list" class="work-inbounds-list">
                                <div class="work-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...</div>
                            </div>
                        </section>

                        <section id="work-client-page" class="work-page hidden">
                            <div class="work-page-head">
                                <button class="work-back-btn" data-work-back="work-clients-page">‚Üê –ù–∞–∑–∞–¥</button>
                                <div class="work-page-title" id="work-client-page-title">–ö–ª–∏–µ–Ω—Ç</div>
                            </div>
                            <div class="card">
                                <div class="left">
                                    <div class="badge">üë§</div>
                                    <div>
                                        <div class="card-title" id="work-client-name">‚Äî</div>
                                        <div class="card-sub" id="work-client-meta">‚Äî</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card work-client-summary-card">
                                <div class="work-client-summary" id="work-client-summary">
                                    <div class="work-client-summary-row">
                                        <div class="work-client-summary-label">–ü–æ–¥–ø–∏—Å–∫–∞</div>
                                        <div class="work-client-summary-value" id="work-client-sub-status">‚Äî</div>
                                    </div>
                                    <div class="work-client-summary-row">
                                        <div class="work-client-summary-label">–î–æ</div>
                                        <div class="work-client-summary-value" id="work-client-sub-until">‚Äî</div>
                                    </div>
                                    <div class="work-client-summary-row">
                                        <div class="work-client-summary-label">–ü–ª–∞—Ç–∏—Ç</div>
                                        <div class="work-client-summary-value" id="work-client-sub-price">‚Äî</div>
                                    </div>
                                    <div class="work-client-summary-row">
                                        <div class="work-client-summary-label">–õ–∏–º–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</div>
                                        <div class="work-client-summary-value" id="work-client-connections-available">‚Äî</div>
                                    </div>
                                </div>
                            </div>
                            <div class="work-actions">
                                <button type="button" class="work-action-link" data-work-nav="work-client-connections-page">
                                    <span class="work-action-link-label">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>
                                    <span class="work-action-link-chevron" aria-hidden="true">‚Ä∫</span>
                                </button>
                                <button type="button" class="work-action-link" data-work-nav="work-client-subscription-page">
                                    <span class="work-action-link-label">–ü–æ–¥–ø–∏—Å–∫–∞</span>
                                    <span class="work-action-link-chevron" aria-hidden="true">‚Ä∫</span>
                                </button>
                            </div>
                        </section>

                        <section id="work-client-connections-page" class="work-page hidden">
                            <div class="work-page-head">
                                <button class="work-back-btn" data-work-back="work-client-page">‚Üê –ù–∞–∑–∞–¥</button>
                                <div class="work-page-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
                            </div>
                            <div class="work-bind">
                                <select id="work-inbound-select">
                                    <option value="">–í—ã–±–µ—Ä–∏ inbound</option>
                                </select>
                                <select id="work-client-select">
                                    <option value="">–í—ã–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ inbound</option>
                                </select>
                                <div class="work-bind-actions">
                                    <button id="work-bind-btn" class="work-btn">–ü—Ä–∏–≤—è–∑–∞—Ç—å inbound</button>
                                    <button id="work-refresh-inbound-clients-btn" type="button" class="work-btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
                                </div>
                                <div class="work-note">–ü–æ—Ä—è–¥–æ–∫: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí inbound ‚Üí –∫–ª–∏–µ–Ω—Ç ‚Üí –ø—Ä–∏–≤—è–∑–∫–∞.</div>
                            </div>
                            <div class="work-page-title">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏</div>
                            <div id="work-existing-links" class="work-links-list">
                                <div class="work-empty">–°–≤—è–∑–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</div>
                            </div>
                        </section>

                        <section id="work-client-subscription-page" class="work-page hidden">
                            <div class="work-page-head">
                                <button class="work-back-btn" data-work-back="work-client-page">‚Üê –ù–∞–∑–∞–¥</button>
                                <div class="work-page-title">–ü–æ–¥–ø–∏—Å–∫–∞</div>
                            </div>
                            <div class="work-bind">
                                <select id="work-sub-status-select">
                                    <option value="active">active</option>
                                    <option value="lifetime">lifetime</option>
                                    <option value="paused">paused</option>
                                    <option value="expired">expired</option>
                                    <option value="canceled">canceled</option>
                                    <option value="inactive">inactive</option>
                                </select>
                                <input id="work-sub-price-input" type="number" min="0" step="0.01" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)">
                                <input id="work-sub-limit-input" type="number" min="0" step="1" placeholder="–õ–∏–º–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π">
                                <button id="work-sub-save-btn" class="work-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
                            </div>
                            <div class="work-bind">
                                <div id="work-sub-extend-wrap" class="work-sub-extend-wrap">
                                    <div class="work-sub-extend-head">
                                        <span class="work-sub-extend-label">–°—Ä–æ–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏—è</span>
                                        <span class="work-sub-extend-value" id="work-sub-extend-value">1 –º–µ—Å—è—Ü</span>
                                    </div>
                                    <input id="work-sub-extend-range" class="work-sub-extend-range" type="range" min="1" max="12" step="1" value="1">
                                </div>
                                <div id="work-sub-create-wrap" class="work-sub-create-wrap hidden">
                                    <label class="work-sub-create-label" for="work-sub-create-date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (–µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç)</label>
                                    <input id="work-sub-create-date" class="work-sub-create-input" type="date">
                                </div>
                                <button id="work-sub-extend-btn" class="work-btn">–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
                            </div>
                        </section>
                    </div>
                    <div id="screen-cloud" class="screen hidden">
                        <div class="work-page-context" id="cloud-page-context">
                            <div class="work-page-pill" id="cloud-page-context-pill" aria-live="polite">–û–±–ª–∞–∫–æ</div>
                        </div>
                        <section class="work-page cloud-page">
                            <div class="cloud-toolbar">
                                <button id="cloud-up-btn" type="button" class="work-back-btn hidden">‚Üê –ù–∞–∑–∞–¥</button>
                                <button id="cloud-refresh-btn" type="button" class="work-back-btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
                            </div>
                            <div class="cloud-path" id="cloud-path">/</div>
                            <div class="cloud-actions">
                                <button id="cloud-new-folder-btn" type="button" class="work-btn">–ù–æ–≤–∞—è –ø–∞–ø–∫–∞</button>
                                <label id="cloud-upload-label" class="work-btn cloud-upload-btn" for="cloud-upload-input">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</label>
                                <input id="cloud-upload-input" type="file" class="hidden" multiple>
                            </div>
                            <div id="cloud-upload-progress" class="cloud-upload-progress hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                <div id="cloud-upload-progress-bar" class="cloud-upload-progress-bar"></div>
                            </div>
                            <div id="cloud-upload-progress-text" class="cloud-upload-progress-text hidden">0%</div>
                            <div id="cloud-status-note" class="cloud-status-note hidden"></div>
                            <div id="cloud-list" class="cloud-list">
                                <div class="work-empty">–û—Ç–∫—Ä–æ–π—Ç–µ –æ–±–ª–∞–∫–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞.</div>
                            </div>
                        </section>
                    </div>
                    <div id="screen-profile" class="screen hidden">
                        <div class="section-title">–ì–ª–∞–≤–Ω–∞—è</div>
                        <div class="card">
                            <div class="left">
                                <div class="badge">ID</div>
                                <div>
                                    <div class="card-title">–í–∞—à ID</div>
                                    <div class="card-sub" id="profile-telegram-id">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                                </div>
                            </div>
                            <div class="pill-soft" id="profile-id-toggle">–°–∫—Ä—ã—Ç</div>
                        </div>

                        <div class="card">
                            <div class="left">
                                <div class="badge">‚úì</div>
                                <div>
                                    <div class="card-title" id="profile-sub-title">–ü–æ–¥–ø–∏—Å–∫–∞</div>
                                    <div class="card-sub" id="profile-sub-sub">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
                                </div>
                            </div>
                            <div class="pill-soft" id="profile-role">user</div>
                        </div>

                        <div class="card support-card">
                            <div class="card-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
                            <div class="card-sub">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –≤ —á–∞—Ç–µ</div>
                        </div>
                    </div>

                <nav class="bottom-nav">
                    <button class="nav-btn active" data-screen="screen-home">
                        <span class="icon">üè†</span>
                        <span>–ì–ª–∞–≤–Ω–∞—è</span>
                    </button>
                    <button class="nav-btn" data-screen="screen-connections">
                        <span class="icon">&#x2B07;&#xFE0F;</span>
                        <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>
                    </button>
                    <button class="nav-btn" data-screen="screen-cloud">
                        <span class="icon">‚òÅÔ∏è</span>
                        <span>–û–±–ª–∞–∫–æ</span>
                    </button>
                    <button class="nav-btn hidden" id="nav-work-btn" data-screen="screen-work">
                        <span class="icon">üõ†</span>
                        <span>–†–∞–±–æ—Ç–∞</span>
                    </button>
                    <button class="nav-btn" data-screen="screen-profile">
                        <span class="icon">üë§</span>
                        <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                    </button>
                </nav>
            </div>
            </div>
        </section>
    </main>

    <script>
        const statusCard = document.getElementById("status-card");
        const statusTitle = document.getElementById("status-title");
        const statusText = document.getElementById("status-text");
        const appContent = document.getElementById("app-content");
        const welcomeTitle = document.getElementById("welcome-title");
        const statusLabel = document.getElementById("status-label");
        const pulseScene = document.getElementById("pulse-scene");
        const loading = document.getElementById("loading");
        const mainEl = document.querySelector("main");
        const orbWrapper = document.querySelector(".orb-wrapper");
        const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
        const navButtons = document.querySelectorAll("[data-screen]");
        const screens = document.querySelectorAll(".screen");
        const heroCardEl = document.getElementById("hero-card");
        const topbarEl = document.getElementById("topbar");
        const workSectionTitleEl = document.getElementById("work-section-title");
        const connectionsPageContextEl = document.getElementById("connections-page-context");
        const connectionsPageContextPillEl = document.getElementById("connections-page-context-pill");
        const workPageContextEl = document.getElementById("work-page-context");
        const workPageContextPillEl = document.getElementById("work-page-context-pill");
        const cloudPageContextEl = document.getElementById("cloud-page-context");
        const cloudPageContextPillEl = document.getElementById("cloud-page-context-pill");
        const bottomNavEl = document.querySelector(".bottom-nav");
        const navWorkBtn = document.getElementById("nav-work-btn");
        const workPages = document.querySelectorAll(".work-page");
        const workNavButtons = document.querySelectorAll("[data-work-nav]");
        const workBackButtons = document.querySelectorAll("[data-work-back]");
        const authUrl = `${window.location.origin}/api/tg/auth`;
        const meUrl = `${window.location.origin}/api/me`;
        const statusUrl = `${window.location.origin}/api/status`;
        const vpnConfigUrl = `${window.location.origin}/api/vpn/config`;
        const vpnHttpUrl = `${window.location.origin}/api/vpn/http`;
        const vpnMixedUrl = `${window.location.origin}/api/vpn/mixed`;
        const adminUsersUrl = `${window.location.origin}/api/admin/users`;
        const adminInboundsUrl = `${window.location.origin}/api/admin/inbounds`;
        const adminSyncInboundsUrl = `${window.location.origin}/api/admin/sync-inbounds`;
        const adminBindClientUrl = `${window.location.origin}/api/admin/bind-client`;
        const adminUnbindClientUrl = `${window.location.origin}/api/admin/unbind-client`;
        const adminPendingBindingsUrl = `${window.location.origin}/api/admin/pending-bindings`;
        const adminCancelPendingBindingUrl = (pendingId) =>
            `${window.location.origin}/api/admin/pending-bindings/${pendingId}/cancel`;
        const adminInboundVisibilityUrl = (panelInboundId) => `${window.location.origin}/api/admin/inbounds/${panelInboundId}/visibility`;
        const adminUserBindingsUrl = (userId) => `${window.location.origin}/api/admin/users/${userId}/bindings`;
        const adminUserOverviewUrl = (userId) => `${window.location.origin}/api/admin/users/${userId}/overview`;
        const adminUserSubscriptionUrl = (userId) => `${window.location.origin}/api/admin/users/${userId}/subscription`;
        const cloudListUrl = `${window.location.origin}/api/cloud/list`;
        const cloudMkdirUrl = `${window.location.origin}/api/cloud/mkdir`;
        const cloudUploadUrl = `${window.location.origin}/api/cloud/upload`;
        const cloudDeleteNodeUrl = (nodeId) => `${window.location.origin}/api/cloud/nodes/${nodeId}`;
        const cloudDownloadFileUrl = (fileId) => `${window.location.origin}/api/cloud/files/${fileId}/download`;
        const homeServerSub = document.getElementById("home-server-sub");
        const homeSubTitle = document.getElementById("home-sub-title");
        const homeSubSub = document.getElementById("home-sub-sub");
        const homeSubRight = document.getElementById("home-sub-right");
        const connectionsMenuPageEl = document.getElementById("connections-menu-page");
        const connectionsDetailPageEl = document.getElementById("connections-detail-page");
        const connectionsBackBtnEl = document.getElementById("connections-back-btn");
        const connectionsDetailTitleEl = document.getElementById("connections-detail-title");
        const connectionsDetailSubtitleEl = document.getElementById("connections-detail-subtitle");
        const connectionsDetailListEl = document.getElementById("connections-detail-list");
        const connectionProtocolButtons = document.querySelectorAll("[data-connection-protocol]");
        const vlessCardEl = document.getElementById("vless-card");
        const httpCardEl = document.getElementById("http-card");
        const mixedCardEl = document.getElementById("mixed-card");
        const connectionsHiddenNoteEl = document.getElementById("connections-hidden-note");
        const vlessStatusEl = document.getElementById("vless-status");
        const vlessDetailEl = document.getElementById("vless-detail");
        const httpStatusEl = document.getElementById("http-status");
        const httpDetailEl = document.getElementById("http-detail");
        const mixedStatusEl = document.getElementById("mixed-status");
        const mixedDetailEl = document.getElementById("mixed-detail");
        const profileTelegramIdEl = document.getElementById("profile-telegram-id");
        const profileIdToggleEl = document.getElementById("profile-id-toggle");
        const profileSubTitleEl = document.getElementById("profile-sub-title");
        const profileSubSubEl = document.getElementById("profile-sub-sub");
        const profileRoleEl = document.getElementById("profile-role");
        const workOwnerNameEl = document.getElementById("work-owner-name");
        const workOwnerRoleEl = document.getElementById("work-owner-role");
        const workRolePillEl = document.getElementById("work-role-pill");
        const workRefreshUsersBtnEl = document.getElementById("work-refresh-users-btn");
        const workSyncInboundsBtnEl = document.getElementById("work-sync-inbounds-btn");
        const workInboundsListEl = document.getElementById("work-inbounds-list");
        const workClientCardsEl = document.getElementById("work-client-cards");
        const workClientPageTitleEl = document.getElementById("work-client-page-title");
        const workClientNameEl = document.getElementById("work-client-name");
        const workClientMetaEl = document.getElementById("work-client-meta");
        const workClientSubStatusEl = document.getElementById("work-client-sub-status");
        const workClientSubUntilEl = document.getElementById("work-client-sub-until");
        const workClientSubPriceEl = document.getElementById("work-client-sub-price");
        const workClientConnectionsAvailableEl = document.getElementById("work-client-connections-available");
        const workExistingLinksEl = document.getElementById("work-existing-links");
        const workInboundSelectEl = document.getElementById("work-inbound-select");
        const workClientSelectEl = document.getElementById("work-client-select");
        const workBindBtnEl = document.getElementById("work-bind-btn");
        const workRefreshInboundClientsBtnEl = document.getElementById("work-refresh-inbound-clients-btn");
        const workPendingTelegramIdEl = document.getElementById("work-pending-telegram-id");
        const workPendingInboundSelectEl = document.getElementById("work-pending-inbound-select");
        const workPendingClientSelectEl = document.getElementById("work-pending-client-select");
        const workPendingAddBtnEl = document.getElementById("work-pending-add-btn");
        const workPendingListEl = document.getElementById("work-pending-list");
        const workSubStatusSelectEl = document.getElementById("work-sub-status-select");
        const workSubPriceInputEl = document.getElementById("work-sub-price-input");
        const workSubLimitInputEl = document.getElementById("work-sub-limit-input");
        const workSubSaveBtnEl = document.getElementById("work-sub-save-btn");
        const workSubExtendWrapEl = document.getElementById("work-sub-extend-wrap");
        const workSubCreateWrapEl = document.getElementById("work-sub-create-wrap");
        const workSubCreateDateEl = document.getElementById("work-sub-create-date");
        const workSubExtendRangeEl = document.getElementById("work-sub-extend-range");
        const workSubExtendValueEl = document.getElementById("work-sub-extend-value");
        const workSubExtendBtnEl = document.getElementById("work-sub-extend-btn");
        const cloudUpBtnEl = document.getElementById("cloud-up-btn");
        const cloudRefreshBtnEl = document.getElementById("cloud-refresh-btn");
        const cloudNewFolderBtnEl = document.getElementById("cloud-new-folder-btn");
        const cloudUploadInputEl = document.getElementById("cloud-upload-input");
        const cloudUploadLabelEl = document.getElementById("cloud-upload-label");
        const cloudUploadProgressEl = document.getElementById("cloud-upload-progress");
        const cloudUploadProgressBarEl = document.getElementById("cloud-upload-progress-bar");
        const cloudUploadProgressTextEl = document.getElementById("cloud-upload-progress-text");
        const cloudPathEl = document.getElementById("cloud-path");
        const cloudStatusNoteEl = document.getElementById("cloud-status-note");
        const cloudListEl = document.getElementById("cloud-list");
        const workState = {
            users: [],
            inbounds: [],
            clients: [],
            bindings: [],
            pendingClients: [],
            pendingBindings: [],
            selectedUserId: null,
            overview: null,
        };
        const FORCE_HIDE_TOPBAR = true;
        const FULLSCREEN_TOP_RESERVE_PX = 28;
        const FULLSCREEN_BOTTOM_RESERVE_PX = 2;
        const connectionsState = {
            activeProtocol: null,
            entries: {
                vless: [],
                http: [],
                mixed: [],
            },
            visibility: {
                vless: false,
                http: false,
                mixed: false,
            },
        };
        const cloudState = {
            path: "/",
            folders: [],
            files: [],
            initialized: false,
            isUploading: false,
        };
        let lastUserPayload = null;
        let showFullTelegramId = false;
        let viewportListenerBound = false;
        let tgBackButtonBound = false;
        const workBackTargetByPage = new Map();
        workBackButtons.forEach((btn) => {
            const pageId = btn.closest(".work-page")?.id;
            if (!pageId) return;
            workBackTargetByPage.set(pageId, btn.dataset.workBack || "work-menu-page");
        });
        const workContextTitleByPage = new Map([
            ["work-staff-page", "–ü–µ—Ä—Å–æ–Ω–∞–ª"],
            ["work-clients-page", "–ö–ª–∏–µ–Ω—Ç—ã"],
            ["work-pending-page", "Pending –¥–æ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞"],
            ["work-inbounds-page", "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è"],
            ["work-client-page", "–ö–ª–∏–µ–Ω—Ç"],
            ["work-client-connections-page", "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è"],
            ["work-client-subscription-page", "–ü–æ–¥–ø–∏—Å–∫–∞"],
        ]);

        function isMobileTelegramPlatform(tg) {
            const platform = String(tg?.platform || "").toLowerCase();
            return platform === "android" || platform === "ios";
        }

        function updateSafeAreaVars(tg) {
            const safeArea = tg?.safeAreaInset || tg?.contentSafeAreaInset;
            const top = Number(safeArea?.top) || 0;
            const bottom = Number(safeArea?.bottom) || 0;
            document.documentElement.style.setProperty("--safe-top", `${top}px`);
            document.documentElement.style.setProperty("--safe-bottom", `${bottom}px`);
        }

        function applyTopReserve(enabled) {
            const reserve = enabled ? FULLSCREEN_TOP_RESERVE_PX : 0;
            document.documentElement.style.setProperty("--system-top-reserve", `${reserve}px`);
        }

        function applyBottomReserve(enabled) {
            const reserve = enabled ? FULLSCREEN_BOTTOM_RESERVE_PX : 0;
            document.documentElement.style.setProperty("--system-nav-reserve", `${reserve}px`);
        }

        function ensureSafeViewportMode() {
            const tg = window.Telegram?.WebApp;
            if (!tg) {
                applyTopReserve(false);
                applyBottomReserve(false);
                return;
            }
            try {
                const isMobile = isMobileTelegramPlatform(tg);
                const canFullscreen = isMobile && typeof tg.requestFullscreen === "function" && tg.isVersionAtLeast?.("8.0");
                updateSafeAreaVars(tg);
                tg.expand?.();
                if (canFullscreen) {
                    try {
                        tg.requestFullscreen();
                    } catch (fullscreenErr) {
                        console.warn("requestFullscreen failed:", fullscreenErr);
                    }
                }
                applyTopReserve(Boolean(tg.isFullscreen) || canFullscreen);
                applyBottomReserve(Boolean(tg.isFullscreen) || canFullscreen);

                if (!viewportListenerBound && typeof tg.onEvent === "function") {
                    tg.onEvent("viewportChanged", () => {
                        updateSafeAreaVars(tg);
                        applyTopReserve(Boolean(tg.isFullscreen) || canFullscreen);
                        applyBottomReserve(Boolean(tg.isFullscreen) || canFullscreen);
                    });
                    viewportListenerBound = true;
                }
            } catch (err) {
                console.error("viewport mode setup error:", err);
            }
        }

        function setTopbarVisibility(shouldHide = false) {
            if (!topbarEl) return;
            if (FORCE_HIDE_TOPBAR || shouldHide) {
                topbarEl.classList.add("hidden");
            } else {
                topbarEl.classList.remove("hidden");
            }
        }

        function getActiveScreenId() {
            const active = Array.from(screens).find((screen) => !screen.classList.contains("hidden"));
            return active?.id || "";
        }

        function getActiveWorkPageId() {
            const active = Array.from(workPages).find((page) => !page.classList.contains("hidden"));
            return active?.id || "";
        }

        function resolveWorkContextTitle(pageId) {
            if (pageId === "work-client-page") {
                const dynamicTitle = String(workClientPageTitleEl?.textContent || "").trim();
                return dynamicTitle || "–ö–ª–∏–µ–Ω—Ç";
            }
            return workContextTitleByPage.get(pageId) || "";
        }

        function updateWorkPageContext(pageId) {
            if (!workPageContextEl || !workPageContextPillEl) return;
            if (!pageId || pageId === "work-menu-page") {
                workPageContextEl.classList.add("hidden");
                return;
            }
            const title = resolveWorkContextTitle(pageId);
            if (!title) {
                workPageContextEl.classList.add("hidden");
                return;
            }
            workPageContextPillEl.textContent = title;
            workPageContextPillEl.title = title;
            workPageContextEl.classList.remove("hidden");
        }

        function updateConnectionsPageContext(protocol) {
            if (!connectionsPageContextEl || !connectionsPageContextPillEl) return;
            if (!protocol) {
                connectionsPageContextEl.classList.add("hidden");
                return;
            }
            const title = connectionProtocolTitle(protocol);
            connectionsPageContextPillEl.textContent = title;
            connectionsPageContextPillEl.title = title;
            connectionsPageContextEl.classList.remove("hidden");
        }

        function cloudPathParts(path) {
            if (!path || path === "/") return [];
            return String(path)
                .split("/")
                .map((part) => part.trim())
                .filter(Boolean);
        }

        function normalizeCloudPath(rawPath) {
            const value = String(rawPath || "/").replace(/\\/g, "/").trim();
            if (!value || value === "/") return "/";
            const parts = value
                .split("/")
                .map((part) => part.trim())
                .filter((part) => part && part !== "." && part !== "..");
            return parts.length ? `/${parts.join("/")}` : "/";
        }

        function cloudParentPath(path) {
            const parts = cloudPathParts(path);
            if (!parts.length) return "/";
            parts.pop();
            return parts.length ? `/${parts.join("/")}` : "/";
        }

        function cloudContextTitle(path) {
            const parts = cloudPathParts(path);
            return parts.length ? parts[parts.length - 1] : "–û–±–ª–∞–∫–æ";
        }

        function updateCloudPageContext(path) {
            if (!cloudPageContextEl || !cloudPageContextPillEl) return;
            const title = cloudContextTitle(path);
            cloudPageContextPillEl.textContent = title;
            cloudPageContextPillEl.title = title;
            cloudPageContextEl.classList.remove("hidden");
        }

        function updateCloudUpButton() {
            if (!cloudUpBtnEl) return;
            const canGoUp = normalizeCloudPath(cloudState.path) !== "/";
            const hideForTelegramBack = hasTelegramBackButton();
            cloudUpBtnEl.classList.toggle("hidden", !canGoUp || hideForTelegramBack);
        }

        function hasTelegramBackButton() {
            const backButton = window.Telegram?.WebApp?.BackButton;
            return Boolean(backButton && typeof backButton.show === "function" && typeof backButton.hide === "function");
        }

        function setCustomBackButtonsVisibility(visible) {
            workBackButtons.forEach((btn) => btn.classList.toggle("hidden", !visible));
            connectionsBackBtnEl?.classList.toggle("hidden", !visible);
            if (!visible) {
                cloudUpBtnEl?.classList.add("hidden");
                return;
            }
            updateCloudUpButton();
        }

        function handleTelegramBack() {
            const activeScreenId = getActiveScreenId();
            if (activeScreenId === "screen-connections" && !connectionsDetailPageEl?.classList.contains("hidden")) {
                openConnectionsMenu();
                return;
            }

            if (activeScreenId === "screen-cloud" && normalizeCloudPath(cloudState.path) !== "/") {
                loadCloudPath(cloudParentPath(cloudState.path)).catch((err) => {
                    console.error("cloud back error:", err);
                });
                return;
            }

            if (activeScreenId === "screen-work") {
                const activePageId = getActiveWorkPageId();
                const backTarget = workBackTargetByPage.get(activePageId);
                if (backTarget) {
                    switchWorkPage(backTarget);
                }
            }
        }

        function shouldShowTelegramBackButton() {
            const activeScreenId = getActiveScreenId();

            if (activeScreenId === "screen-connections") {
                return !connectionsDetailPageEl?.classList.contains("hidden");
            }

            if (activeScreenId === "screen-work") {
                const activePageId = getActiveWorkPageId();
                return Boolean(workBackTargetByPage.get(activePageId));
            }

            if (activeScreenId === "screen-cloud") {
                return normalizeCloudPath(cloudState.path) !== "/";
            }

            return false;
        }

        function updateTelegramBackButton() {
            const backButton = window.Telegram?.WebApp?.BackButton;
            if (!backButton) return;

            const shouldShow = shouldShowTelegramBackButton();
            if (shouldShow) {
                if (!tgBackButtonBound && typeof backButton.onClick === "function") {
                    backButton.onClick(handleTelegramBack);
                    tgBackButtonBound = true;
                }
                backButton.show?.();
                return;
            }

            backButton.hide?.();
            updateCloudUpButton();
        }

        function syncBackNavigationMode() {
            const useTelegramBack = hasTelegramBackButton();
            setCustomBackButtonsVisibility(!useTelegramBack);
            if (useTelegramBack) {
                updateTelegramBackButton();
            }
            updateCloudUpButton();
        }

        function runRevealAnimation() {
            return new Promise((resolve) => {
                if (!orbWrapper) return resolve();
                const done = () => {
                    orbWrapper.removeEventListener("animationend", done);
                    resolve();
                };
                orbWrapper.addEventListener("animationend", done);
                orbWrapper.classList.add("expand");
                loading.classList.add("exiting");
                setTimeout(resolve, 750); // fallback
            });
        }

        async function showApp(userName) {
            welcomeTitle.textContent = userName ? `Lumica Service ‚Ä¢ ${userName}` : "Lumica Service";
            await runRevealAnimation();
            loading.classList.add("hidden");
            statusCard.classList.add("hidden");
            appContent.classList.remove("hidden");
            mainEl.classList.remove("hidden");
            // –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            requestAnimationFrame(() => {
                mainEl.classList.add("visible");
            });
        }

        function showError(message) {
            loading.classList.add("hidden");
            mainEl.classList.remove("hidden");
            requestAnimationFrame(() => {
                mainEl.classList.add("visible");
            });
            statusTitle.textContent = "–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç";
            statusText.textContent = message || "–í–∞–ª–∏–¥–∞—Ü–∏—è Telegram initData –Ω–µ –ø—Ä–æ—à–ª–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—É—Å–∫ –º–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.";
            appContent.classList.add("hidden");
            statusCard.classList.remove("hidden");
        }

        const DEV_MODE = new URLSearchParams(window.location.search).get("dev") === "1";
        console.log("DEV_MODE", DEV_MODE);

        function fmtDate(iso) {
            if (!iso) return "–Ω–µ –∑–∞–¥–∞–Ω–æ";
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return "–Ω–µ –∑–∞–¥–∞–Ω–æ";
            return d.toLocaleDateString("ru-RU", { day: "2-digit", month: "long", year: "numeric" });
        }

        function normalizeSubscriptionStatus(status) {
            return String(status || "").trim().toLowerCase();
        }

        function isSubscriptionActive(subscription) {
            const status = normalizeSubscriptionStatus(subscription?.status);
            return status === "active" || status === "lifetime";
        }

        function isSubscriptionLifetime(subscription) {
            return normalizeSubscriptionStatus(subscription?.status) === "lifetime";
        }

        function formatSubscriptionUntil(subscription, formatter = fmtDateTime) {
            if (!subscription) return "\u2014";
            if (isSubscriptionLifetime(subscription)) return "\u0411\u0435\u0441\u0441\u0440\u043e\u0447\u043d\u043e";
            return subscription?.access_until ? formatter(subscription.access_until) : "\u2014";
        }

        function maskTelegramId(raw) {
            if (!raw) return "‚Äî";
            const text = String(raw);
            if (text.length <= 4) return text;
            return `‚Ä¢‚Ä¢‚Ä¢‚Ä¢${text.slice(-4)}`;
        }

        function renderTelegramId() {
            const telegramId = lastUserPayload?.user?.telegram_id;
            if (!telegramId) {
                profileTelegramIdEl.textContent = "‚Äî";
                profileIdToggleEl.textContent = "–ù–µ—Ç";
                return;
            }
            profileTelegramIdEl.textContent = showFullTelegramId ? String(telegramId) : maskTelegramId(telegramId);
            profileIdToggleEl.textContent = showFullTelegramId ? "–°–∫—Ä—ã—Ç—å" : "–ü–æ–∫–∞–∑–∞—Ç—å";
        }

        function fmtConnectionsCount(n) {
            const value = Number(n) || 0;
            const mod10 = value % 10;
            const mod100 = value % 100;
            if (mod10 === 1 && mod100 !== 11) return `${value} –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ`;
            if (mod10 >= 2 && mod10 <= 4 && (mod100 < 10 || mod100 >= 20)) return `${value} –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è`;
            return `${value} –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π`;
        }

        function normalizeVlessConnections(payload) {
            const rows = Array.isArray(payload?.connections) ? payload.connections : [];
            if (rows.length) {
                return rows.filter((row) => row?.vless_url);
            }
            if (payload?.ok && payload?.vless_url) {
                return [
                    {
                        label: payload?.identifier || "VLESS",
                        host: payload?.host,
                        port: payload?.port,
                        vless_url: payload?.vless_url,
                        inbound_remark: null,
                    },
                ];
            }
            return [];
        }

        function normalizeMixedConnections(payload) {
            const rows = Array.isArray(payload?.connections) ? payload.connections : [];
            if (rows.length) {
                return rows.filter((row) => Array.isArray(row?.urls) && row.urls.length);
            }
            if (payload?.ok && Array.isArray(payload?.urls) && payload.urls.length) {
                return [
                    {
                        label: payload?.username || "MIXED",
                        host: payload?.host,
                        port: payload?.port,
                        username: payload?.username || null,
                        password: payload?.password || null,
                        urls: payload?.urls,
                        inbound_remark: null,
                    },
                ];
            }
            return [];
        }

        function normalizeHttpConnections(payload) {
            const rows = Array.isArray(payload?.connections) ? payload.connections : [];
            if (rows.length) {
                return rows.filter((row) => Array.isArray(row?.urls) && row.urls.length);
            }
            if (payload?.ok && Array.isArray(payload?.urls) && payload.urls.length) {
                return [
                    {
                        label: payload?.username || "HTTP",
                        host: payload?.host,
                        port: payload?.port,
                        urls: payload?.urls,
                        inbound_remark: null,
                    },
                ];
            }
            return [];
        }

        function connectionProtocolTitle(protocol) {
            if (protocol === "vless") return "VLESS";
            if (protocol === "http") return "HTTP Proxy";
            if (protocol === "mixed") return "Mixed (SOCKS5)";
            return "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
        }

        function buildConnectionsInfoText(protocol, rows) {
            const safeRows = Array.isArray(rows) ? rows : [];
            const hosts = [...new Set(safeRows.map((r) => String(r?.host || "").trim()).filter(Boolean))];
            const ports = [...new Set(safeRows.map((r) => String(r?.port ?? "").trim()).filter(Boolean))];

            return [
                "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è—Ö",
                `–ü—Ä–æ—Ç–æ–∫–æ–ª: ${connectionProtocolTitle(protocol)}`,
                `–•–æ—Å—Ç: ${hosts.join(", ") || "‚Äî"}`,
                `–ü–æ—Ä—Ç: ${ports.join(", ") || "‚Äî"}`,
            ].join("\n");
        }

        function detectUrlType(url) {
            const raw = String(url || "").trim().toLowerCase();
            if (raw.startsWith("vless://")) return "VLESS";
            if (raw.startsWith("socks5://")) return "SOCKS5";
            if (raw.startsWith("https://")) return "HTTPS";
            if (raw.startsWith("http://")) return "HTTP";
            return "–°—Å—ã–ª–∫–∞";
        }

        function buildTelegramSocksUrl(row) {
            const host = String(row?.host || "").trim();
            const port = String(row?.port ?? "").trim();
            const user = String(row?.username || row?.identifier || "").trim();
            const pass = String(row?.password || "").trim();
            if (!host || !port || !user || !pass) return "";
            return `https://t.me/socks?server=${encodeURIComponent(host)}&port=${encodeURIComponent(port)}&user=${encodeURIComponent(user)}&pass=${encodeURIComponent(pass)}`;
        }

        function openExternalLink(url) {
            const link = String(url || "").trim();
            if (!link) return;
            if (link.startsWith("https://t.me/") && window.Telegram?.WebApp?.openTelegramLink) {
                window.Telegram.WebApp.openTelegramLink(link);
                return;
            }
            if (window.Telegram?.WebApp?.openLink) {
                window.Telegram.WebApp.openLink(link);
                return;
            }
            window.open(link, "_blank", "noopener,noreferrer");
        }

        async function copyToClipboard(value) {
            const text = String(value || "").trim();
            if (!text) throw new Error("empty value");
            if (navigator.clipboard?.writeText) {
                await navigator.clipboard.writeText(text);
                return;
            }
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.setAttribute("readonly", "");
            ta.style.position = "fixed";
            ta.style.left = "-1000px";
            ta.style.top = "-1000px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
        }

        function connectionCopyItems(protocol, row) {
            if (protocol === "vless") {
                return row?.vless_url
                    ? [{ label: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å VLESS", value: row.vless_url, action: "copy" }]
                    : [];
            }
            if (protocol === "mixed") {
                const user = String(row?.username || row?.identifier || "").trim();
                const pass = String(row?.password || "").trim();
                const tgSocksUrl = buildTelegramSocksUrl(row);
                const actions = [];
                if (pass) actions.push({ label: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å", value: pass, action: "copy" });
                if (tgSocksUrl) {
                    actions.push({ label: "–î–æ–±–∞–≤–∏—Ç—å –≤ –¢–≥", value: tgSocksUrl, action: "open" });
                }
                return actions;
            }
            const urls = Array.isArray(row?.urls) ? row.urls : [];
            return urls
                .filter(Boolean)
                .map((url) => ({ label: `–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ${detectUrlType(url)}`, value: url, action: "copy" }));
        }

        function openConnectionsMenu() {
            connectionsState.activeProtocol = null;
            connectionsMenuPageEl?.classList.remove("hidden");
            connectionsDetailPageEl?.classList.add("hidden");
            updateConnectionsPageContext(null);
            updateTelegramBackButton();
        }

        function renderConnectionsDetail(protocol) {
            if (!connectionsDetailListEl) return;
            const rows = Array.isArray(connectionsState.entries?.[protocol]) ? connectionsState.entries[protocol] : [];
            const title = connectionProtocolTitle(protocol);
            connectionsDetailTitleEl.textContent = title;
            connectionsDetailTitleEl.title = title;
            updateConnectionsPageContext(protocol);
            connectionsDetailSubtitleEl.textContent = buildConnectionsInfoText(protocol, rows);
            connectionsDetailListEl.innerHTML = "";

            if (!rows.length) {
                const empty = document.createElement("div");
                empty.className = "work-empty";
                empty.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
                connectionsDetailListEl.appendChild(empty);
                return;
            }

            rows.forEach((row, idx) => {
                const item = document.createElement("div");
                item.className = "connection-item";

                const itemTitle = document.createElement("div");
                itemTitle.className = "connection-item-title";
                const mixedEmail = String(row?.username || row?.identifier || "").trim();
                const rawTitle = String(row?.label || "").trim();
                let displayTitle = rawTitle || `${title} #${idx + 1}`;
                if (protocol === "mixed" && mixedEmail) {
                    const sameAsEmail = displayTitle.toLowerCase() === mixedEmail.toLowerCase();
                    if (sameAsEmail) {
                        displayTitle = `–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ #${idx + 1}`;
                    }
                }
                itemTitle.textContent = displayTitle;

                if (protocol === "mixed") {
                    const meta = document.createElement("div");
                    meta.className = "connection-item-meta";

                    const emailLine = document.createElement("div");
                    emailLine.textContent = `–ü–æ—á—Ç–∞: ${mixedEmail || "‚Äî"}`;

                    meta.appendChild(emailLine);
                    item.appendChild(meta);
                }

                const copyRow = document.createElement("div");
                copyRow.className = "connection-copy-row";
                const copies = connectionCopyItems(protocol, row);
                copies.forEach((entry) => {
                    const copyBtn = document.createElement("button");
                    copyBtn.type = "button";
                    copyBtn.className = "connection-copy-btn";
                    copyBtn.textContent = entry.label;
                    copyBtn.addEventListener("click", async () => {
                        const baseText = entry.label;
                        try {
                            if (entry.action === "open") {
                                openExternalLink(entry.value);
                                copyBtn.textContent = "–û—Ç–∫—Ä—ã—Ç–æ";
                            } else {
                                await copyToClipboard(entry.value);
                                copyBtn.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
                            }
                        } catch (_err) {
                            copyBtn.textContent = "–û—à–∏–±–∫–∞";
                        }
                        setTimeout(() => {
                            copyBtn.textContent = baseText;
                        }, 1000);
                    });
                    copyRow.appendChild(copyBtn);
                });

                item.appendChild(itemTitle);
                item.appendChild(copyRow);
                connectionsDetailListEl.appendChild(item);
            });
        }

        function openConnectionsDetail(protocol) {
            if (!connectionsState.visibility?.[protocol]) return;
            const rows = Array.isArray(connectionsState.entries?.[protocol]) ? connectionsState.entries[protocol] : [];
            if (!rows.length) return;
            connectionsState.activeProtocol = protocol;
            renderConnectionsDetail(protocol);
            connectionsMenuPageEl?.classList.add("hidden");
            connectionsDetailPageEl?.classList.remove("hidden");
            updateTelegramBackButton();
        }

        function renderDashboard(data) {
            const me = data?.me;
            const service = data?.status?.services;
            const subscription = me?.subscription;
            const subActive = isSubscriptionActive(subscription);
            const lifetimeSub = isSubscriptionLifetime(subscription);
            const subscriptionUntil = formatSubscriptionUntil(subscription, fmtDate);
            const vless = data?.vless;
            const http = data?.http;
            const mixed = data?.mixed;

            lastUserPayload = me || null;
            const userRole = me?.user?.role || "user";
            const isOwner = userRole === "owner";
            profileRoleEl.textContent = userRole;
            workRolePillEl.textContent = userRole;
            workOwnerNameEl.textContent = me?.user?.name || me?.user?.first_name || me?.user?.username || "–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è";
            workOwnerRoleEl.textContent = userRole;
            navWorkBtn.classList.toggle("hidden", !isOwner);
            bottomNavEl.classList.toggle("with-work", isOwner);
            if (!isOwner) {
                const activeWork = navWorkBtn.classList.contains("active");
                if (activeWork) switchScreen("screen-home");
            } else {
                loadWorkClientsData().catch((err) => {
                    console.error("load clients error:", err);
                });
            }
            renderTelegramId();

            const showVlessCard = service?.vless?.visible_in_app !== false;
            const showHttpCard = service?.http?.visible_in_app === true;
            const showMixedCard =
                service?.mixed?.visible_in_app === true ||
                (service?.mixed === undefined && service?.https_mixed?.visible_in_app !== false);
            const vlessConnections = normalizeVlessConnections(vless);
            const httpConnections = normalizeHttpConnections(http);
            const mixedConnections = normalizeMixedConnections(mixed);
            connectionsState.visibility.vless = showVlessCard;
            connectionsState.visibility.http = showHttpCard;
            connectionsState.visibility.mixed = showMixedCard;
            connectionsState.entries.vless = showVlessCard ? vlessConnections : [];
            connectionsState.entries.http = showHttpCard ? httpConnections : [];
            connectionsState.entries.mixed = showMixedCard ? mixedConnections : [];
            vlessCardEl?.classList.toggle("hidden", !showVlessCard);
            httpCardEl?.classList.toggle("hidden", !showHttpCard);
            mixedCardEl?.classList.toggle("hidden", !showMixedCard);
            connectionsHiddenNoteEl?.classList.toggle("hidden", showVlessCard || showHttpCard || showMixedCard);
            if (connectionsState.activeProtocol && !connectionsState.visibility[connectionsState.activeProtocol]) {
                openConnectionsMenu();
            } else if (connectionsState.activeProtocol) {
                renderConnectionsDetail(connectionsState.activeProtocol);
            }

            homeServerSub.textContent = service?.vless?.ok || service?.https_mixed?.ok ? "–°–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã" : "–°–µ—Ä–≤–∏—Å—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã";
            if (subActive) {
                homeSubTitle.textContent = "–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞";
                homeSubSub.textContent = "–î–æ—Å—Ç—É–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω";
                homeSubRight.textContent = lifetimeSub ? "–ë–µ–∑ —Å—Ä–æ–∫–∞" : `–î–æ: ${subscriptionUntil}`;
                profileSubTitleEl.textContent = "–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞";
                profileSubSubEl.textContent = lifetimeSub ? "–î–æ—Å—Ç—É–ø: –±–µ—Å—Å—Ä–æ—á–Ω–æ" : `–î–æ—Å—Ç—É–ø –¥–æ: ${subscriptionUntil}`;
                document.getElementById("hero-sub").textContent = lifetimeSub ? "–ë–µ—Å—Å—Ä–æ—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞" : `–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ ${subscriptionUntil}`;
            } else {
                homeSubTitle.textContent = "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
                homeSubSub.textContent = "–û—Ñ–æ—Ä–º–∏—Ç–µ/–ø—Ä–æ–¥–ª–∏—Ç–µ –¥–æ—Å—Ç—É–ø";
                homeSubRight.textContent = "‚Äî";
                profileSubTitleEl.textContent = "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞";
                profileSubSubEl.textContent = "–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω";
                document.getElementById("hero-sub").textContent = "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞";
            }

            if (vlessConnections.length) {
                vlessStatusEl.textContent = `–ì–æ—Ç–æ–≤–æ ‚Ä¢ ${fmtConnectionsCount(vlessConnections.length)}`;
                vlessDetailEl.textContent = "‚Ä∫";
            } else {
                vlessStatusEl.textContent = "–ù–µ –≤—ã–¥–∞–Ω–æ";
                vlessDetailEl.textContent = "‚Äî";
            }

            if (httpConnections.length) {
                httpStatusEl.textContent = `–ì–æ—Ç–æ–≤–æ ‚Ä¢ ${fmtConnectionsCount(httpConnections.length)}`;
                httpDetailEl.textContent = "‚Ä∫";
            } else {
                httpStatusEl.textContent = "–ù–µ –≤—ã–¥–∞–Ω–æ";
                httpDetailEl.textContent = "‚Äî";
            }

            if (mixedConnections.length) {
                mixedStatusEl.textContent = `–ì–æ—Ç–æ–≤–æ ‚Ä¢ ${fmtConnectionsCount(mixedConnections.length)}`;
                mixedDetailEl.textContent = "‚Ä∫";
            } else {
                mixedStatusEl.textContent = "–ù–µ –≤—ã–¥–∞–Ω–æ";
                mixedDetailEl.textContent = "‚Äî";
            }
        }

        async function fetchJson(url, optional = false) {
            const response = await fetch(url, {
                method: "GET",
                credentials: "same-origin",
            });
            let payload = {};
            try {
                payload = await response.json();
            } catch (_e) {
                payload = {};
            }
            if (!response.ok || payload?.ok === false) {
                if (optional) return null;
                throw new Error(payload.error || `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ${url}`);
            }
            return payload;
        }

        async function postJson(url, body = null) {
            const response = await fetch(url, {
                method: "POST",
                credentials: "same-origin",
                headers: { "Content-Type": "application/json" },
                body: body ? JSON.stringify(body) : null,
            });
            let payload = {};
            try {
                payload = await response.json();
            } catch (_e) {
                payload = {};
            }
            if (!response.ok || payload?.ok === false) {
                throw new Error(payload.error || `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ${url}`);
            }
            return payload;
        }

        async function deleteJson(url) {
            const response = await fetch(url, {
                method: "DELETE",
                credentials: "same-origin",
            });
            let payload = {};
            try {
                payload = await response.json();
            } catch (_e) {
                payload = {};
            }
            if (!response.ok || payload?.ok === false) {
                throw new Error(payload.error || `–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ${url}`);
            }
            return payload;
        }

        function fmtCloudSize(sizeBytes) {
            const value = Number(sizeBytes);
            if (!Number.isFinite(value) || value < 0) return "‚Äî";
            if (value < 1024) return `${value} –ë`;
            const units = ["–ö–ë", "–ú–ë", "–ì–ë", "–¢–ë"];
            let current = value;
            let unitIdx = -1;
            while (current >= 1024 && unitIdx < units.length - 1) {
                current /= 1024;
                unitIdx += 1;
            }
            return `${current.toFixed(current >= 100 ? 0 : 1)} ${units[unitIdx]}`;
        }

        function setCloudStatus(text = "", tone = "info") {
            if (!cloudStatusNoteEl) return;
            const message = String(text || "").trim();
            cloudStatusNoteEl.classList.remove("error", "success");
            if (!message) {
                cloudStatusNoteEl.textContent = "";
                cloudStatusNoteEl.classList.add("hidden");
                return;
            }
            if (tone === "error" || tone === "success") {
                cloudStatusNoteEl.classList.add(tone);
            }
            cloudStatusNoteEl.textContent = message;
            cloudStatusNoteEl.classList.remove("hidden");
        }

        function setCloudUploadProgress(percent, text = "") {
            const safePercent = Math.max(0, Math.min(100, Number(percent) || 0));
            if (cloudUploadProgressBarEl) {
                cloudUploadProgressBarEl.style.width = `${safePercent}%`;
            }
            if (cloudUploadProgressEl) {
                cloudUploadProgressEl.classList.remove("hidden");
                cloudUploadProgressEl.setAttribute("aria-valuenow", String(Math.round(safePercent)));
            }
            if (cloudUploadProgressTextEl) {
                cloudUploadProgressTextEl.textContent = text || `${Math.round(safePercent)}%`;
                cloudUploadProgressTextEl.classList.remove("hidden");
            }
        }

        function resetCloudUploadProgress(hide = true) {
            if (cloudUploadProgressBarEl) {
                cloudUploadProgressBarEl.style.width = "0%";
            }
            if (cloudUploadProgressEl) {
                cloudUploadProgressEl.setAttribute("aria-valuenow", "0");
                if (hide) {
                    cloudUploadProgressEl.classList.add("hidden");
                }
            }
            if (cloudUploadProgressTextEl) {
                cloudUploadProgressTextEl.textContent = "0%";
                if (hide) {
                    cloudUploadProgressTextEl.classList.add("hidden");
                }
            }
        }

        async function uploadSingleCloudFile(file, targetPath, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open("POST", cloudUploadUrl, true);
                xhr.withCredentials = true;
                xhr.timeout = 0;

                xhr.upload.onprogress = (event) => {
                    if (!onProgress) return;
                    const total = event.lengthComputable ? Number(event.total) : Number(file?.size || 0);
                    onProgress(Number(event.loaded || 0), total);
                };

                xhr.onerror = () => {
                    reject(new Error("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ"));
                };
                xhr.ontimeout = () => {
                    reject(new Error("–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞"));
                };
                xhr.onabort = () => {
                    reject(new Error("–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"));
                };
                xhr.onload = () => {
                    let payload = {};
                    try {
                        payload = JSON.parse(xhr.responseText || "{}");
                    } catch (_e) {
                        payload = {};
                    }
                    if (xhr.status >= 200 && xhr.status < 300 && payload?.ok !== false) {
                        resolve(payload);
                        return;
                    }

                    const rawText = String(xhr.responseText || "").trim();
                    const serverError = String(payload?.error || "").trim();
                    const looksLikeHtml = /^<!doctype|^<html/i.test(rawText);
                    const fallbackByStatus =
                        xhr.status === 413
                            ? "–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è nginx (–ª–∏–º–∏—Ç client_max_body_size)"
                            : xhr.status === 504
                                ? "Nginx –Ω–µ –¥–æ–∂–¥–∞–ª—Å—è –æ—Ç–≤–µ—Ç–∞ –±—ç–∫–µ–Ω–¥–∞ (—É–≤–µ–ª–∏—á—å—Ç–µ proxy_read_timeout/proxy_send_timeout)"
                                : xhr.status === 502
                                    ? "–û—à–∏–±–∫–∞ —à–ª—é–∑–∞ –º–µ–∂–¥—É nginx –∏ –±—ç–∫–µ–Ω–¥–æ–º/Telegram"
                            : xhr.statusText || `HTTP ${xhr.status}`;
                    const detail =
                        serverError
                        || (xhr.status === 413
                            ? fallbackByStatus
                            : (!looksLikeHtml && rawText ? rawText : fallbackByStatus));
                    reject(new Error(`${detail} (HTTP ${xhr.status})`));
                };

                const formData = new FormData();
                formData.append("path", targetPath);
                formData.append("file", file, file.name);
                xhr.send(formData);
            });
        }

        function renderCloudList() {
            if (!cloudListEl) return;
            cloudListEl.innerHTML = "";
            const folders = Array.isArray(cloudState.folders) ? cloudState.folders : [];
            const files = Array.isArray(cloudState.files) ? cloudState.files : [];

            if (!folders.length && !files.length) {
                const empty = document.createElement("div");
                empty.className = "work-empty";
                empty.textContent = "–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É.";
                cloudListEl.appendChild(empty);
                return;
            }

            folders.forEach((folder) => {
                const row = document.createElement("div");
                row.className = "cloud-node-card";

                const head = document.createElement("div");
                head.className = "cloud-node-head";

                const openBtn = document.createElement("button");
                openBtn.type = "button";
                openBtn.className = "cloud-node-open";
                openBtn.textContent = `üìÅ ${folder.name || "–ü–∞–ø–∫–∞"}`;
                openBtn.addEventListener("click", () => {
                    loadCloudPath(folder.path || "/").catch((err) => {
                        console.error("open folder error:", err);
                        setCloudStatus(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É", "error");
                    });
                });

                const actions = document.createElement("div");
                actions.className = "cloud-node-actions";

                const deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.className = "cloud-node-action danger";
                deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
                deleteBtn.addEventListener("click", async () => {
                    if (!window.confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "${folder.name}"?`)) return;
                    try {
                        await deleteJson(cloudDeleteNodeUrl(folder.node_id));
                        await loadCloudPath(cloudState.path);
                        setCloudStatus(`–ü–∞–ø–∫–∞ "${folder.name}" —É–¥–∞–ª–µ–Ω–∞`, "success");
                    } catch (err) {
                        console.error("delete folder error:", err);
                        setCloudStatus(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É", "error");
                    }
                });

                actions.appendChild(deleteBtn);
                head.appendChild(openBtn);
                head.appendChild(actions);

                const sub = document.createElement("div");
                sub.className = "cloud-node-sub";
                sub.textContent = "–ü–∞–ø–∫–∞";

                row.appendChild(head);
                row.appendChild(sub);
                cloudListEl.appendChild(row);
            });

            files.forEach((fileNode) => {
                const fileMeta = fileNode?.file || {};
                const isReady = String(fileMeta?.status || "").toLowerCase() === "ready";

                const row = document.createElement("div");
                row.className = "cloud-node-card";

                const head = document.createElement("div");
                head.className = "cloud-node-head";

                const title = document.createElement("div");
                title.className = "cloud-node-open";
                title.textContent = `üìÑ ${fileNode?.name || "–§–∞–π–ª"}`;
                title.style.cursor = "default";

                const actions = document.createElement("div");
                actions.className = "cloud-node-actions";

                const downloadBtn = document.createElement("button");
                downloadBtn.type = "button";
                downloadBtn.className = "cloud-node-action";
                downloadBtn.textContent = "–°–∫–∞—á–∞—Ç—å";
                downloadBtn.disabled = !isReady || !fileMeta?.file_id;
                downloadBtn.addEventListener("click", () => {
                    if (!fileMeta?.file_id || !isReady) return;
                    const a = document.createElement("a");
                    a.href = cloudDownloadFileUrl(fileMeta.file_id);
                    a.download = String(fileMeta.original_name || fileNode?.name || "download.bin");
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setCloudStatus(`–°–∫–∞—á–∏–≤–∞–Ω–∏–µ: ${fileNode?.name || "—Ñ–∞–π–ª"}`, "success");
                });

                const deleteBtn = document.createElement("button");
                deleteBtn.type = "button";
                deleteBtn.className = "cloud-node-action danger";
                deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
                deleteBtn.addEventListener("click", async () => {
                    if (!window.confirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${fileNode?.name}"?`)) return;
                    try {
                        await deleteJson(cloudDeleteNodeUrl(fileNode.node_id));
                        await loadCloudPath(cloudState.path);
                        setCloudStatus(`–§–∞–π–ª "${fileNode?.name}" —É–¥–∞–ª–µ–Ω`, "success");
                    } catch (err) {
                        console.error("delete file error:", err);
                        setCloudStatus(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª", "error");
                    }
                });

                actions.appendChild(downloadBtn);
                actions.appendChild(deleteBtn);
                head.appendChild(title);
                head.appendChild(actions);

                const sizeText = fmtCloudSize(fileMeta?.size_bytes);
                const chunksText = Number(fileMeta?.chunk_count) > 0 ? `${fileMeta.chunk_count} —á–∞–Ω–∫(–æ–≤)` : "0 —á–∞–Ω–∫–æ–≤";
                const statusText = fileMeta?.status || "unknown";
                const sub = document.createElement("div");
                sub.className = "cloud-node-sub";
                sub.textContent = `${sizeText} ‚Ä¢ ${chunksText} ‚Ä¢ ${statusText}`;

                row.appendChild(head);
                row.appendChild(sub);
                cloudListEl.appendChild(row);
            });
        }

        async function loadCloudPath(path, options = {}) {
            const preserveStatus = Boolean(options?.preserveStatus);
            const nextPath = normalizeCloudPath(path || "/");
            cloudState.path = nextPath;
            if (cloudPathEl) {
                cloudPathEl.textContent = nextPath;
                cloudPathEl.title = nextPath;
            }
            updateCloudPageContext(nextPath);
            updateCloudUpButton();
            updateTelegramBackButton();

            if (cloudListEl) {
                cloudListEl.innerHTML = '<div class="work-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            }
            try {
                const payload = await fetchJson(`${cloudListUrl}?path=${encodeURIComponent(nextPath)}`, false);
                cloudState.folders = Array.isArray(payload?.folders) ? payload.folders : [];
                cloudState.files = Array.isArray(payload?.files) ? payload.files : [];
                cloudState.path = normalizeCloudPath(payload?.path || nextPath);
                if (cloudPathEl) {
                    cloudPathEl.textContent = cloudState.path;
                    cloudPathEl.title = cloudState.path;
                }
                updateCloudPageContext(cloudState.path);
                cloudState.initialized = true;
                renderCloudList();
                if (!preserveStatus) {
                    setCloudStatus("");
                }
            } catch (err) {
                const message = String(err?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–∞–∫–æ");
                if (nextPath !== "/" && message.toLowerCase().includes("folder not found")) {
                    return loadCloudPath(cloudParentPath(nextPath), options);
                }
                cloudState.folders = [];
                cloudState.files = [];
                if (cloudListEl) {
                    cloudListEl.innerHTML = '<div class="work-empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–±–ª–∞–∫–∞.</div>';
                }
                setCloudStatus(message, "error");
                throw err;
            } finally {
                updateCloudUpButton();
                updateTelegramBackButton();
            }
        }

        async function ensureCloudLoaded(force = false) {
            updateCloudPageContext(cloudState.path);
            if (!force && cloudState.initialized) {
                updateCloudUpButton();
                return;
            }
            await loadCloudPath(cloudState.path);
        }

        async function createCloudFolder() {
            const rawName = window.prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–∞–ø–∫–∏");
            if (rawName === null) return;
            const name = String(rawName).trim();
            if (!name) {
                setCloudStatus("–ò–º—è –ø–∞–ø–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º", "error");
                return;
            }
            try {
                const result = await postJson(cloudMkdirUrl, {
                    parent_path: cloudState.path,
                    name,
                });
                await loadCloudPath(cloudState.path);
                setCloudStatus(
                    result?.existing ? `–ü–∞–ø–∫–∞ "${name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç` : `–ü–∞–ø–∫–∞ "${name}" —Å–æ–∑–¥–∞–Ω–∞`,
                    result?.existing ? "info" : "success"
                );
            } catch (err) {
                console.error("mkdir error:", err);
                setCloudStatus(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É", "error");
            }
        }

        async function uploadCloudFiles(fileList) {
            const files = Array.from(fileList || []);
            if (!files.length || cloudState.isUploading) return;

            cloudState.isUploading = true;
            cloudUploadInputEl && (cloudUploadInputEl.disabled = true);
            cloudUploadLabelEl?.classList.add("disabled");
            cloudRefreshBtnEl && (cloudRefreshBtnEl.disabled = true);
            cloudNewFolderBtnEl && (cloudNewFolderBtnEl.disabled = true);
            cloudUpBtnEl && (cloudUpBtnEl.disabled = true);

            let uploaded = 0;
            let failed = 0;
            const uploadErrors = [];
            const totalBytes = files.reduce((sum, file) => sum + Math.max(0, Number(file?.size) || 0), 0);
            const totalFiles = files.length;
            let processedBytes = 0;
            resetCloudUploadProgress(false);
            setCloudUploadProgress(0, "–ó–∞–≥—Ä—É–∑–∫–∞: 0%");

            try {
                for (const file of files) {
                    const fileSize = Math.max(0, Number(file?.size) || 0);
                    setCloudStatus(`–ó–∞–≥—Ä—É–∑–∫–∞: ${file.name}`);
                    try {
                        await uploadSingleCloudFile(file, cloudState.path, (loaded, total) => {
                            const effectiveTotal = total > 0 ? total : fileSize;
                            let percent = 0;
                            if (totalBytes > 0) {
                                const safeLoaded = Math.max(0, Math.min(Number(loaded || 0), effectiveTotal || Number(loaded || 0)));
                                const overallLoaded = Math.min(processedBytes + safeLoaded, totalBytes);
                                percent = (overallLoaded / totalBytes) * 100;
                            } else {
                                const perFileProgress = effectiveTotal > 0 ? Math.min(Number(loaded || 0) / effectiveTotal, 1) : 0;
                                percent = ((uploaded + perFileProgress) / totalFiles) * 100;
                            }
                            setCloudUploadProgress(percent, `–ó–∞–≥—Ä—É–∑–∫–∞: ${Math.round(percent)}%`);
                        });
                        uploaded += 1;
                    } catch (err) {
                        failed += 1;
                        console.error("upload error:", err);
                        const reason = String(err?.message || "upload failed").trim();
                        uploadErrors.push({
                            fileName: file.name,
                            reason,
                        });
                    } finally {
                        processedBytes += fileSize;
                        const processedFiles = uploaded + failed;
                        const percent =
                            totalBytes > 0
                                ? (processedBytes / totalBytes) * 100
                                : (processedFiles / totalFiles) * 100;
                        setCloudUploadProgress(percent, `–ó–∞–≥—Ä—É–∑–∫–∞: ${Math.round(percent)}%`);
                    }
                }

                await loadCloudPath(cloudState.path, { preserveStatus: true });
                if (failed === 0) {
                    setCloudUploadProgress(100, "–ó–∞–≥—Ä—É–∑–∫–∞: 100%");
                    setCloudStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${uploaded}`, "success");
                    setTimeout(() => {
                        if (!cloudState.isUploading) {
                            resetCloudUploadProgress(true);
                        }
                    }, 1200);
                    return;
                }

                const firstError = uploadErrors[0];
                if (uploaded === 0 && failed === 1 && firstError) {
                    setCloudStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ "${firstError.fileName}": ${firstError.reason}`, "error");
                    return;
                }

                const summary = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${uploaded}, –æ—à–∏–±–æ–∫: ${failed}`;
                if (firstError) {
                    const prefix = failed > 1 ? "–ü–µ—Ä–≤–∞—è –æ—à–∏–±–∫–∞" : "–û—à–∏–±–∫–∞";
                    setCloudStatus(`${summary}. ${prefix}: "${firstError.fileName}" ‚Äî ${firstError.reason}`, "error");
                    return;
                }
                setCloudStatus(summary, "error");
            } finally {
                cloudState.isUploading = false;
                cloudUploadInputEl && (cloudUploadInputEl.disabled = false);
                cloudUploadLabelEl?.classList.remove("disabled");
                cloudRefreshBtnEl && (cloudRefreshBtnEl.disabled = false);
                cloudNewFolderBtnEl && (cloudNewFolderBtnEl.disabled = false);
                cloudUpBtnEl && (cloudUpBtnEl.disabled = false);
            }
        }

        function fillSelect(el, items, mapLabel, mapValue, emptyText) {
            if (!el) return;
            el.innerHTML = "";
            const empty = document.createElement("option");
            empty.value = "";
            empty.textContent = emptyText;
            el.appendChild(empty);
            items.forEach((item, idx) => {
                const opt = document.createElement("option");
                opt.value = mapValue(item, idx);
                opt.textContent = mapLabel(item, idx);
                el.appendChild(opt);
            });
        }

        function inboundOptionLabel(inbound) {
            const panelState = inbound?.enable ? "panel:on" : "panel:off";
            const appState = inbound?.show_in_app ? "app:visible" : "app:hidden";
            return `${inbound.panel_inbound_id} ‚Ä¢ ${inbound.protocol || "unknown"} ‚Ä¢ ${inbound.remark || "no-remark"} ‚Ä¢ ${panelState} ‚Ä¢ ${appState}`;
        }

        function renderWorkInboundSelectOptions() {
            if (!workInboundSelectEl) return;
            const selected = workInboundSelectEl.value;
            fillSelect(
                workInboundSelectEl,
                workState.inbounds,
                (i) => inboundOptionLabel(i),
                (i) => String(i.panel_inbound_id),
                "–í—ã–±–µ—Ä–∏ inbound"
            );
            if (selected && workState.inbounds.some((i) => String(i.panel_inbound_id) === selected)) {
                workInboundSelectEl.value = selected;
            }
        }

        function renderWorkPendingInboundSelectOptions() {
            if (!workPendingInboundSelectEl) return;
            const selected = workPendingInboundSelectEl.value;
            fillSelect(
                workPendingInboundSelectEl,
                workState.inbounds,
                (i) => inboundOptionLabel(i),
                (i) => String(i.panel_inbound_id),
                "–í—ã–±–µ—Ä–∏ inbound"
            );
            if (selected && workState.inbounds.some((i) => String(i.panel_inbound_id) === selected)) {
                workPendingInboundSelectEl.value = selected;
            }
        }

        function fmtDateTime(iso) {
            if (!iso) return "‚Äî";
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return "‚Äî";
            return d.toLocaleString("ru-RU", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
            });
        }

        function fmtMoney(value) {
            if (value === null || value === undefined || value === "") return "‚Äî";
            const n = Number(value);
            if (Number.isNaN(n)) return "‚Äî";
            return `${n.toLocaleString("ru-RU")} ‚ÇΩ`;
        }

        function fmtMonthsText(months) {
            const m = Number(months) || 0;
            if (m % 10 === 1 && m % 100 !== 11) return `${m} –º–µ—Å—è—Ü`;
            if (m % 10 >= 2 && m % 10 <= 4 && (m % 100 < 10 || m % 100 >= 20)) return `${m} –º–µ—Å—è—Ü–∞`;
            return `${m} –º–µ—Å—è—Ü–µ–≤`;
        }

        function toInputDateValue(dateObj) {
            if (!(dateObj instanceof Date) || Number.isNaN(dateObj.getTime())) return "";
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, "0");
            const day = String(dateObj.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        function defaultSubscriptionDateValue(days = 30) {
            const target = new Date();
            target.setHours(0, 0, 0, 0);
            target.setDate(target.getDate() + Math.max(1, Number(days) || 30));
            return toInputDateValue(target);
        }

        function validateSubscriptionDateValue(rawDate) {
            const clean = String(rawDate || "").trim();
            if (!clean) {
                throw new Error("–£–∫–∞–∂–∏ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏");
            }
            const ts = Date.parse(`${clean}T00:00:00`);
            if (Number.isNaN(ts)) {
                throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã");
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (ts < today.getTime()) {
                throw new Error("–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º");
            }
            return `${clean}T23:59:59`;
        }

        function renderWorkSubscriptionControls(sub) {
            const hasSubscription = Boolean(sub);
            const lifetimeSubscription = isSubscriptionLifetime(sub);
            const createAsLifetime =
                !hasSubscription && normalizeSubscriptionStatus(workSubStatusSelectEl?.value) === "lifetime";
            workSubExtendWrapEl?.classList.toggle("hidden", !hasSubscription || lifetimeSubscription);
            workSubCreateWrapEl?.classList.toggle("hidden", hasSubscription || createAsLifetime);

            if (workSubExtendBtnEl) {
                if (!hasSubscription && createAsLifetime) {
                    workSubExtendBtnEl.textContent = "–°–æ–∑–¥–∞—Ç—å –±–µ—Å—Å—Ä–æ—á–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É";
                } else {
                    workSubExtendBtnEl.textContent = hasSubscription ? "–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" : "–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É";
                }
                workSubExtendBtnEl.classList.toggle("hidden", hasSubscription && lifetimeSubscription);
            }

            if (workSubCreateDateEl) {
                if (!hasSubscription && !createAsLifetime && !workSubCreateDateEl.value) {
                    workSubCreateDateEl.value = defaultSubscriptionDateValue(30);
                }
                if (createAsLifetime) {
                    workSubCreateDateEl.value = "";
                }
                if (hasSubscription && !lifetimeSubscription && sub?.access_until) {
                    const accessUntil = new Date(sub.access_until);
                    if (!Number.isNaN(accessUntil.getTime())) {
                        workSubCreateDateEl.value = toInputDateValue(accessUntil);
                    }
                }
            }
        }

        function renderWorkSubExtendValue() {
            if (!workSubExtendRangeEl || !workSubExtendValueEl) return;
            const min = Number(workSubExtendRangeEl.min || 0);
            const max = Number(workSubExtendRangeEl.max || 100);
            const value = Number(workSubExtendRangeEl.value || min);
            const percent = max > min ? ((value - min) / (max - min)) * 100 : 0;
            workSubExtendRangeEl.style.setProperty("--work-sub-progress", `${percent}%`);
            workSubExtendValueEl.textContent = fmtMonthsText(value);
        }

        function renderWorkClientCards() {
            if (!workClientCardsEl) return;
            workClientCardsEl.innerHTML = "";

            if (!Array.isArray(workState.users) || !workState.users.length) {
                const empty = document.createElement("div");
                empty.className = "work-empty";
                empty.textContent = "–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
                workClientCardsEl.appendChild(empty);
                return;
            }

            workState.users.forEach((user) => {
                const card = document.createElement("button");
                card.type = "button";
                card.className = "work-client-card";
                card.dataset.userId = String(user.id);

                const title = document.createElement("div");
                title.className = "work-client-card-title";
                title.textContent = user.name || user.username || `–ö–ª–∏–µ–Ω—Ç #${user.id}`;

                const sub = document.createElement("div");
                sub.className = "work-client-card-sub";
                sub.textContent = `${user.id} ¬∑ ${user.username ? `@${user.username}` : "‚Äî"}`;

                card.appendChild(title);
                card.appendChild(sub);
                card.addEventListener("click", () => {
                    openWorkClientPage(user.id).catch((err) => {
                        console.error("open client error:", err);
                    });
                });
                workClientCardsEl.appendChild(card);
            });
        }

        function renderWorkInboundsManager() {
            if (!workInboundsListEl) return;
            workInboundsListEl.innerHTML = "";

            const rows = Array.isArray(workState.inbounds) ? workState.inbounds : [];
            if (!rows.length) {
                const empty = document.createElement("div");
                empty.className = "work-empty";
                empty.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞–∂–º–∏ ¬´–°–∏–Ω—Ö—Ä.¬ª";
                workInboundsListEl.appendChild(empty);
                return;
            }

            rows.forEach((inbound) => {
                const panelId = Number(inbound?.panel_inbound_id || 0);
                const panelEnabled = Boolean(inbound?.enable);
                const visibleForUsers = Boolean(inbound?.show_in_app);

                const card = document.createElement("div");
                card.className = "work-inbound-card";

                const head = document.createElement("div");
                head.className = "work-inbound-head";

                const title = document.createElement("div");
                title.className = "work-inbound-title";
                title.textContent = String(inbound?.remark || `Inbound ${panelId}`).trim() || `Inbound ${panelId}`;

                const badges = document.createElement("div");
                badges.className = "work-inbound-badges";

                const panelBadge = document.createElement("span");
                panelBadge.className = `work-inbound-pill${panelEnabled ? "" : " off"}`;
                panelBadge.textContent = panelEnabled ? "–ü–∞–Ω–µ–ª—å: on" : "–ü–∞–Ω–µ–ª—å: off";

                const visibilityBadge = document.createElement("span");
                visibilityBadge.className = `work-inbound-pill${visibleForUsers ? "" : " off"}`;
                visibilityBadge.textContent = visibleForUsers ? "–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: –≤–∏–¥–Ω–æ" : "–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏: —Å–∫—Ä—ã—Ç–æ";

                badges.appendChild(panelBadge);
                badges.appendChild(visibilityBadge);
                head.appendChild(title);
                head.appendChild(badges);

                const meta = document.createElement("div");
                meta.className = "work-inbound-meta";
                const protocol = String(inbound?.protocol || "unknown").toLowerCase();
                meta.textContent = `#${panelId} ‚Ä¢ ${protocol} ‚Ä¢ –ø–æ—Ä—Ç: ${inbound?.port ?? "‚Äî"}`;

                const toggleBtn = document.createElement("button");
                toggleBtn.type = "button";
                toggleBtn.className = "work-inbound-toggle-btn";
                toggleBtn.textContent = visibleForUsers ? "–°–∫—Ä—ã—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π" : "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º";
                toggleBtn.addEventListener("click", async () => {
                    await runWorkAction("Toggle Inbound Visibility", async () => {
                        const result = await postJson(adminInboundVisibilityUrl(panelId), {
                            show_in_app: !visibleForUsers,
                        });
                        const updated = result?.inbound || null;
                        if (updated) {
                            workState.inbounds = workState.inbounds.map((row) =>
                                String(row?.panel_inbound_id) === String(updated.panel_inbound_id)
                                    ? { ...row, ...updated }
                                    : row
                            );
                            renderWorkInboundsManager();
                            renderWorkInboundSelectOptions();
                        } else {
                            await loadWorkClientsData();
                        }
                        return result;
                    });
                });

                card.appendChild(head);
                card.appendChild(meta);
                card.appendChild(toggleBtn);
                workInboundsListEl.appendChild(card);
            });
        }

        function renderExistingBindings(bindings) {
            if (!workExistingLinksEl) return;
            workExistingLinksEl.innerHTML = "";

            if (!Array.isArray(bindings) || !bindings.length) {
                const empty = document.createElement("div");
                empty.className = "work-empty";
                empty.textContent = "–°–≤—è–∑–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.";
                workExistingLinksEl.appendChild(empty);
                return;
            }

            const groups = new Map();
            bindings.forEach((binding) => {
                const inboundId = binding.panel_inbound_id ?? "‚Äî";
                const connectionName = (binding.inbound_remark || "").trim() || `Inbound ${inboundId}`;
                const key = `${inboundId}::${connectionName}`;
                if (!groups.has(key)) {
                    groups.set(key, {
                        connectionName,
                        clients: [],
                        statuses: [],
                        latestUpdated: null,
                    });
                }
                const group = groups.get(key);
                const label = String(binding.label || binding.identifier || "‚Äî").trim() || "‚Äî";
                const status = String(binding.status || "‚Äî").trim() || "‚Äî";
                group.clients.push({
                    id: binding.id,
                    label,
                });
                if (!group.statuses.includes(status)) group.statuses.push(status);

                const updated = binding.updated_at ? new Date(binding.updated_at) : null;
                if (updated && !Number.isNaN(updated.getTime())) {
                    if (!group.latestUpdated || updated > group.latestUpdated) {
                        group.latestUpdated = updated;
                    }
                }
            });

            groups.forEach((group) => {
                const item = document.createElement("div");
                item.className = "work-link-item";

                const title = document.createElement("div");
                title.className = "work-link-item-title";
                title.textContent = group.connectionName;

                const statusLine = document.createElement("div");
                statusLine.className = "work-link-item-sub";
                statusLine.textContent = `status: ${group.statuses.join(" ‚Ä¢ ") || "‚Äî"}`;

                const updatedLine = document.createElement("div");
                updatedLine.className = "work-link-item-sub";
                updatedLine.textContent = `–æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${group.latestUpdated ? fmtDateTime(group.latestUpdated.toISOString()) : "‚Äî"}`;

                const clientsWrap = document.createElement("div");
                clientsWrap.className = "work-link-clients";
                group.clients.forEach((client) => {
                    const row = document.createElement("div");
                    row.className = "work-link-client";

                    const name = document.createElement("div");
                    name.className = "work-link-client-name";
                    name.textContent = client.label;

                    const removeBtn = document.createElement("button");
                    removeBtn.type = "button";
                    removeBtn.className = "work-link-client-remove";
                    removeBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
                    removeBtn.addEventListener("click", async (event) => {
                        event.stopPropagation();
                        await runWorkAction("Delete Binding", async () => {
                            await postJson(adminUnbindClientUrl, { binding_id: client.id });
                            await loadSelectedUserBindings();
                            await loadSelectedUserOverview();
                            return { deleted: client.id };
                        });
                    });

                    row.appendChild(name);
                    row.appendChild(removeBtn);
                    clientsWrap.appendChild(row);
                });

                item.appendChild(title);
                item.appendChild(statusLine);
                item.appendChild(updatedLine);
                item.appendChild(clientsWrap);
                workExistingLinksEl.appendChild(item);
            });
        }

        function resolveInboundClientSelection(inboundSelectEl, clientSelectEl, clients, emptyMessage) {
            const panelInboundId = inboundSelectEl?.value;
            const clientIndex = clientSelectEl?.value;
            if (!panelInboundId || clientIndex === "") {
                throw new Error(emptyMessage || "–í—ã–±–µ—Ä–∏ inbound –∏ –∫–ª–∏–µ–Ω—Ç–∞");
            }

            const inbound = workState.inbounds.find((i) => String(i.panel_inbound_id) === String(panelInboundId));
            const client = Array.isArray(clients) ? clients[Number(clientIndex)] : null;
            if (!client || !inbound) {
                throw new Error("–î–∞–Ω–Ω—ã–µ inbound/client –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
            }
            return { panelInboundId: Number(panelInboundId), inbound, client };
        }

        function renderPendingBindings(rows) {
            if (!workPendingListEl) return;
            workPendingListEl.innerHTML = "";

            if (!Array.isArray(rows) || !rows.length) {
                const empty = document.createElement("div");
                empty.className = "work-empty";
                empty.textContent = "Pending-–ø—Ä–∏–≤—è–∑–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.";
                workPendingListEl.appendChild(empty);
                return;
            }

            rows.forEach((row) => {
                const item = document.createElement("div");
                item.className = "work-link-item";

                const title = document.createElement("div");
                title.className = "work-link-item-title";
                title.textContent = row?.inbound_remark || row?.label || row?.identifier || `Inbound ${row?.panel_inbound_id ?? "‚Äî"}`;

                const line1 = document.createElement("div");
                line1.className = "work-link-item-sub";
                line1.textContent = `TG: ${row?.telegram_id || "‚Äî"} ‚Ä¢ client: ${row?.label || row?.identifier || "‚Äî"}`;

                const line2 = document.createElement("div");
                line2.className = "work-link-item-sub";
                line2.textContent = `status: ${row?.status || "‚Äî"} ‚Ä¢ protocol: ${row?.protocol || "‚Äî"}`;

                item.appendChild(title);
                item.appendChild(line1);
                item.appendChild(line2);

                if (String(row?.status || "").toLowerCase() === "pending") {
                    const rowActions = document.createElement("div");
                    rowActions.className = "work-link-clients";

                    const rowActionWrap = document.createElement("div");
                    rowActionWrap.className = "work-link-client";

                    const rowActionName = document.createElement("div");
                    rowActionName.className = "work-link-client-name";
                    rowActionName.textContent = "–û–∂–∏–¥–∞–µ—Ç –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞";

                    const cancelBtn = document.createElement("button");
                    cancelBtn.type = "button";
                    cancelBtn.className = "work-link-client-remove";
                    cancelBtn.textContent = "–û—Ç–º–µ–Ω–∏—Ç—å";
                    cancelBtn.addEventListener("click", async (event) => {
                        event.stopPropagation();
                        await runWorkAction("Cancel Pending Binding", async () => {
                            await postJson(adminCancelPendingBindingUrl(row.id));
                            await loadPendingBindings(workPendingTelegramIdEl?.value);
                            return { canceled: row.id };
                        });
                    });

                    rowActionWrap.appendChild(rowActionName);
                    rowActionWrap.appendChild(cancelBtn);
                    rowActions.appendChild(rowActionWrap);
                    item.appendChild(rowActions);
                }

                workPendingListEl.appendChild(item);
            });
        }

        async function loadPendingBindings(telegramIdRaw) {
            const telegramId = String(telegramIdRaw || "").trim();
            if (!telegramId) {
                workState.pendingBindings = [];
                renderPendingBindings([]);
                return { ok: true, pending_bindings: [] };
            }
            const url = `${adminPendingBindingsUrl}?telegram_id=${encodeURIComponent(telegramId)}&limit=200`;
            const resp = await fetchJson(url, false);
            workState.pendingBindings = Array.isArray(resp?.pending_bindings) ? resp.pending_bindings : [];
            renderPendingBindings(workState.pendingBindings);
            return resp;
        }

        function renderWorkClientOverview(overview) {
            workState.overview = overview || null;
            const sub = overview?.subscription || null;
            const conn = overview?.connections || null;
            renderWorkSubscriptionControls(sub);

            workClientSubStatusEl.textContent = sub?.status || "–Ω–µ—Ç";
            workClientSubUntilEl.textContent = formatSubscriptionUntil(sub, fmtDateTime);
            workClientSubPriceEl.textContent = fmtMoney(sub?.price_amount);

            if (!conn) {
                workClientConnectionsAvailableEl.textContent = "‚Äî";
            } else if (conn.limit === null || conn.limit === undefined) {
                workClientConnectionsAvailableEl.textContent = `${conn.active ?? 0}/‚àû`;
            } else {
                workClientConnectionsAvailableEl.textContent = `${conn.active ?? 0}/${conn.limit}`;
            }

            if (workSubStatusSelectEl) {
                workSubStatusSelectEl.value = sub?.status || "active";
            }
            if (workSubPriceInputEl) {
                workSubPriceInputEl.value = sub?.price_amount ?? "";
            }
            if (workSubLimitInputEl) {
                workSubLimitInputEl.value =
                    conn?.limit === null || conn?.limit === undefined ? "" : String(conn.limit);
            }
        }

        async function loadSelectedUserOverview() {
            if (!workState.selectedUserId) {
                renderWorkClientOverview(null);
                return { ok: true, overview: null };
            }
            const resp = await fetchJson(adminUserOverviewUrl(workState.selectedUserId), false);
            renderWorkClientOverview(resp?.overview || null);
            return resp;
        }

        function setSelectedWorkClient(user) {
            if (!user) {
                workClientPageTitleEl.textContent = "–ö–ª–∏–µ–Ω—Ç";
                workClientPageTitleEl.title = "–ö–ª–∏–µ–Ω—Ç";
                if (getActiveWorkPageId() === "work-client-page") {
                    updateWorkPageContext("work-client-page");
                }
                workClientNameEl.textContent = "‚Äî";
                workClientMetaEl.textContent = "‚Äî";
                renderWorkClientOverview(null);
                return;
            }
            const title = user.name || user.username || `–ö–ª–∏–µ–Ω—Ç #${user.id}`;
            workClientPageTitleEl.textContent = title;
            workClientPageTitleEl.title = title;
            if (getActiveWorkPageId() === "work-client-page") {
                updateWorkPageContext("work-client-page");
            }
            workClientNameEl.textContent = title;
            workClientMetaEl.textContent = `${user.id} ¬∑ ${user.username ? `@${user.username}` : "‚Äî"}`;
        }

        async function loadWorkClientsData() {
            const [usersResp, inboundsResp] = await Promise.all([
                fetchJson(adminUsersUrl, false),
                fetchJson(adminInboundsUrl, false),
            ]);
            workState.users = Array.isArray(usersResp?.users) ? usersResp.users : [];
            workState.inbounds = Array.isArray(inboundsResp?.inbounds) ? inboundsResp.inbounds : [];
            renderWorkClientCards();
            renderWorkInboundsManager();
            renderWorkInboundSelectOptions();
            renderWorkPendingInboundSelectOptions();
            fillSelect(
                workClientSelectEl,
                [],
                () => "",
                () => "",
                "Select client from inbound"
            );
            fillSelect(
                workPendingClientSelectEl,
                [],
                () => "",
                () => "",
                "Select client from inbound"
            );
            workState.clients = [];
            workState.pendingClients = [];
            if (workPendingInboundSelectEl?.value) {
                await loadPendingInboundClients(workPendingInboundSelectEl.value);
            }
            const pendingTgId = workPendingTelegramIdEl?.value?.trim();
            if (pendingTgId) {
                await loadPendingBindings(pendingTgId);
            } else {
                workState.pendingBindings = [];
                renderPendingBindings([]);
            }
            return { users: workState.users.length, inbounds: workState.inbounds.length };
        }

        async function loadSelectedUserBindings() {
            if (!workState.selectedUserId) {
                workState.bindings = [];
                renderExistingBindings([]);
                return { bindings: 0 };
            }
            const resp = await fetchJson(adminUserBindingsUrl(workState.selectedUserId), false);
            workState.bindings = Array.isArray(resp?.bindings) ? resp.bindings : [];
            renderExistingBindings(workState.bindings);
            return { bindings: workState.bindings.length };
        }

        async function openWorkClientPage(userId) {
            const user = workState.users.find((u) => String(u.id) === String(userId));
            if (!user) {
                throw new Error("–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
            }

            workState.selectedUserId = user.id;
            setSelectedWorkClient(user);
            if (workPendingTelegramIdEl) {
                workPendingTelegramIdEl.value = user?.telegram_id ? String(user.telegram_id) : "";
            }
            if (workSubCreateDateEl) {
                workSubCreateDateEl.value = "";
            }
            switchWorkPage("work-client-page");

            fillSelect(
                workClientSelectEl,
                [],
                () => "",
                () => "",
                "–í—ã–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ inbound"
            );
            workState.clients = [];
            if (workInboundSelectEl?.value) {
                await loadInboundClients(workInboundSelectEl.value);
            }
            const pendingTgId = workPendingTelegramIdEl?.value?.trim();
            await Promise.all([
                loadSelectedUserBindings(),
                loadSelectedUserOverview(),
                pendingTgId ? loadPendingBindings(pendingTgId) : Promise.resolve(),
            ]);
        }

        async function loadInboundClients(panelInboundId) {
            if (!panelInboundId) {
                workState.clients = [];
                fillSelect(workClientSelectEl, [], () => "", () => "", "–í—ã–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ inbound");
                return;
            }
            const resp = await fetchJson(`${window.location.origin}/api/admin/inbounds/${panelInboundId}/clients`, false);
            workState.clients = Array.isArray(resp?.clients) ? resp.clients : [];
            fillSelect(
                workClientSelectEl,
                workState.clients,
                (c, idx) => `${idx + 1}. ${c.label || "–ö–ª–∏–µ–Ω—Ç"}`,
                (_, idx) => String(idx),
                "–í—ã–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ inbound"
            );
        }

        async function refreshInboundClientsFromPanel() {
            const panelInboundId = workInboundSelectEl?.value?.trim();
            if (!panelInboundId) {
                throw new Error("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ inbound");
            }

            await postJson(adminSyncInboundsUrl);
            const inboundsResp = await fetchJson(adminInboundsUrl, false);
            workState.inbounds = Array.isArray(inboundsResp?.inbounds) ? inboundsResp.inbounds : [];
            renderWorkInboundsManager();
            renderWorkInboundSelectOptions();
            renderWorkPendingInboundSelectOptions();

            const exists = workState.inbounds.some((row) => String(row?.panel_inbound_id) === panelInboundId);
            if (!exists) {
                workState.clients = [];
                fillSelect(workClientSelectEl, [], () => "", () => "", "–í—ã–±–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ inbound");
                throw new Error(`Inbound ${panelInboundId} –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`);
            }

            if (workInboundSelectEl) {
                workInboundSelectEl.value = panelInboundId;
            }
            await loadInboundClients(panelInboundId);
            if (workPendingInboundSelectEl?.value === panelInboundId) {
                await loadPendingInboundClients(panelInboundId);
            }

            return { inbounds: workState.inbounds.length, clients: workState.clients.length };
        }


        async function loadPendingInboundClients(panelInboundId) {
            if (!panelInboundId) {
                workState.pendingClients = [];
                fillSelect(workPendingClientSelectEl, [], () => "", () => "", "Select client from inbound");
                return;
            }
            const resp = await fetchJson(`${window.location.origin}/api/admin/inbounds/${panelInboundId}/clients`, false);
            workState.pendingClients = Array.isArray(resp?.clients) ? resp.clients : [];
            fillSelect(
                workPendingClientSelectEl,
                workState.pendingClients,
                (c, idx) => `${idx + 1}. ${c.label || "Client"}`,
                (_, idx) => String(idx),
                "Select client from inbound"
            );
        }

        function switchWorkPage(target) {
            const next = target || "work-menu-page";
            workPages.forEach((page) => page.classList.toggle("hidden", page.id !== next));
            const hideWorkHeaders = next !== "work-menu-page";
            setTopbarVisibility(hideWorkHeaders);
            workSectionTitleEl?.classList.toggle("hidden", hideWorkHeaders);
            updateWorkPageContext(next);
            updateTelegramBackButton();
        }

        function switchScreen(target) {
            heroCardEl?.classList.toggle("hidden", target !== "screen-home");
            navButtons.forEach((b) => b.classList.toggle("active", b.dataset.screen === target));
            screens.forEach((s) => s.classList.toggle("hidden", s.id !== target));
            if (target !== "screen-work") {
                setTopbarVisibility(false);
                workSectionTitleEl?.classList.remove("hidden");
            }
            if (target === "screen-work") {
                switchWorkPage("work-menu-page");
            }
            if (target !== "screen-connections") {
                openConnectionsMenu();
            }
            if (target === "screen-cloud") {
                ensureCloudLoaded().catch((err) => {
                    console.error("cloud init error:", err);
                });
            }
            updateTelegramBackButton();
            updateCloudUpButton();
        }

        async function runWorkAction(title, action) {
            try {
                await action();
            } catch (err) {
                console.error(`${title} ERROR:`, err);
            }
        }

        async function loadRuntimeData() {
            if (DEV_MODE) {
                return {
                    me: {
                        ok: true,
                        user: { telegram_id: "999000111", role: "admin", name: "Dev Mode" },
                        subscription: { status: "active", access_until: new Date(Date.now() + 86400000 * 30).toISOString() },
                    },
                    status: {
                        ok: true,
                        services: {
                            vless: { ok: true, visible_in_app: true },
                            http: { ok: true, visible_in_app: true },
                            mixed: { ok: true, visible_in_app: true },
                            https_mixed: { ok: true, visible_in_app: true },
                        },
                    },
                    vless: {
                        ok: true,
                        host: "dev.local",
                        port: 443,
                        vless_url: "vless://demo",
                        connections: [
                            { label: "Dev-VLESS-1", host: "dev.local", port: 443, vless_url: "vless://demo1" },
                            { label: "Dev-VLESS-2", host: "dev.local", port: 443, vless_url: "vless://demo2" },
                        ],
                    },
                    http: {
                        ok: true,
                        host: "dev.local",
                        port: 8080,
                        urls: ["http://demo"],
                        connections: [
                            { label: "Dev-HTTP-1", host: "dev.local", port: 8080, urls: ["http://demo-http-1"] },
                        ],
                    },
                    mixed: {
                        ok: true,
                        host: "dev.local",
                        port: 8443,
                        username: "DEV_USER",
                        password: "DEV_PASS",
                        urls: ["socks5://demo"],
                        connections: [
                            { label: "Dev-Mixed-1", host: "dev.local", port: 8443, username: "CAR011NA", password: "yLO06l4AFM", urls: ["socks5://demo1", "http://demo1"] },
                            { label: "Dev-Mixed-2", host: "dev.local", port: 8443, username: "BYTEARC", password: "pass_2", urls: ["socks5://demo2", "http://demo2"] },
                        ],
                    },
                };
            }

            const [me, status, vless, http, mixed] = await Promise.all([
                fetchJson(meUrl, false),
                fetchJson(statusUrl, false),
                fetchJson(vpnConfigUrl, true),
                fetchJson(vpnHttpUrl, true),
                fetchJson(vpnMixedUrl, true),
            ]);
            return { me, status, vless, http, mixed };
        }

        const statusSteps = [
            { text: "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä‚Ä¶", glow: "rgba(55, 224, 255, 0.55)" },
            { text: "–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è‚Ä¶", glow: "rgba(79, 123, 255, 0.55)" },
            { text: "–ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ‚Ä¶", glow: "rgba(168, 85, 247, 0.55)" },
        ];
        let statusIndex = 0;

        function cycleStatus() {
            statusLabel.classList.add("fade-out");
            setTimeout(() => {
                statusIndex = (statusIndex + 1) % statusSteps.length;
                const step = statusSteps[statusIndex];
                statusLabel.textContent = step.text;
                pulseScene?.style.setProperty("--glow-color", step.glow);
                statusLabel.classList.remove("fade-out");
            }, 160);
        }

        const CYCLE_MS = 4800; // —É–¥–ª–∏–Ω—ë–Ω–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (–±—ã–ª–æ 2400)
        setInterval(cycleStatus, CYCLE_MS);
        pulseScene?.style.setProperty("--glow-color", statusSteps[0].glow);

        async function validateUser() {
            if (DEV_MODE) {
                const fakeUser = {
                    id: 0,
                    username: "dev_user",
                    first_name: "Dev",
                    last_name: "Mode",
                };
                return { ok: true, user: fakeUser };
            }

            const initData = window.Telegram?.WebApp?.initData;
            console.log("initData present:", Boolean(initData));
            if (!initData) {
                throw new Error("–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ Telegram Web App. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.");
            }

            console.log("sending /api/tg/auth");
            const response = await fetch(authUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify({ initData }),
            });

            let payload;
            try {
                payload = await response.json();
            } catch (e) {
                const raw = await response.text();
                console.error("Auth raw response:", raw);
                throw new Error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ-JSON: " + raw.slice(0, 120));
            }

            if (!response.ok || !payload.ok) {
                throw new Error(payload.error || "–¢–µ–ª–µ–≥—Ä–∞–º –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
            }

            return payload;
        }

        async function init() {
            console.log("Init start");
            try {
                window.Telegram?.WebApp?.ready?.();
                ensureSafeViewportMode();
                syncBackNavigationMode();
                setTopbarVisibility(false);
                const payload = await validateUser();
                console.log("Auth ok", payload.user);
                const runtime = await loadRuntimeData();
                renderDashboard(runtime);
                const delay = payload?.show_long_intro ? 2400 : 400;
                await wait(delay);
                await showApp(payload.user?.first_name || payload.user?.username);
            } catch (err) {
                console.error("Auth failed", err);
                showError(err.message);
            } finally {
                // —Å—Ç—Ä–∞—Ö—É–µ–º—Å—è –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –ª–æ–∞–¥–µ—Ä–∞
                loading.classList.add("hidden");
                mainEl.classList.remove("hidden");
            }
        }

        if (document.readyState === "loading") {
            window.addEventListener("DOMContentLoaded", init);
        } else {
            init();
        }

        // bottom nav (–ø—Ä–æ—Å—Ç–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤)
        navButtons.forEach((btn) =>
            btn.addEventListener("click", () => {
                switchScreen(btn.dataset.screen);
            })
        );

        connectionProtocolButtons.forEach((btn) =>
            btn.addEventListener("click", () => {
                const protocol = btn.dataset.connectionProtocol;
                if (!protocol) return;
                openConnectionsDetail(protocol);
            })
        );

        connectionsBackBtnEl?.addEventListener("click", () => {
            openConnectionsMenu();
        });

        cloudUpBtnEl?.addEventListener("click", () => {
            loadCloudPath(cloudParentPath(cloudState.path)).catch((err) => {
                console.error("cloud up error:", err);
                setCloudStatus(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –ø–∞–ø–∫—É", "error");
            });
        });

        cloudRefreshBtnEl?.addEventListener("click", () => {
            ensureCloudLoaded(true).catch((err) => {
                console.error("cloud refresh error:", err);
                setCloudStatus(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫", "error");
            });
        });

        cloudNewFolderBtnEl?.addEventListener("click", async () => {
            await createCloudFolder();
        });

        cloudUploadInputEl?.addEventListener("change", async () => {
            const files = cloudUploadInputEl?.files;
            if (!files || !files.length) return;
            try {
                await uploadCloudFiles(files);
            } finally {
                cloudUploadInputEl.value = "";
            }
        });

        workNavButtons.forEach((btn) =>
            btn.addEventListener("click", () => {
                switchWorkPage(btn.dataset.workNav || "work-menu-page");
            })
        );

        workBackButtons.forEach((btn) =>
            btn.addEventListener("click", () => {
                switchWorkPage(btn.dataset.workBack || "work-menu-page");
            })
        );

        profileIdToggleEl?.addEventListener("click", () => {
            showFullTelegramId = !showFullTelegramId;
            renderTelegramId();
        });

        workRefreshUsersBtnEl?.addEventListener("click", async () => {
            await runWorkAction("Load Clients List", async () => {
                return loadWorkClientsData();
            });
        });

        workSyncInboundsBtnEl?.addEventListener("click", async () => {
            await runWorkAction("Sync Inbounds", async () => {
                await postJson(adminSyncInboundsUrl);
                return loadWorkClientsData();
            });
        });

        workRefreshInboundClientsBtnEl?.addEventListener("click", async () => {
            await runWorkAction("Refresh Inbound Clients", async () => {
                return refreshInboundClientsFromPanel();
            });
        });

        workInboundSelectEl?.addEventListener("change", async () => {
            workState.clients = [];
            fillSelect(workClientSelectEl, [], () => "", () => "", "Select client from inbound");
            if (!workInboundSelectEl?.value) {
                return;
            }
            try {
                await loadInboundClients(workInboundSelectEl.value);
            } catch (err) {
                console.error("load inbound clients error:", err);
            }
        });

        workPendingInboundSelectEl?.addEventListener("change", async () => {
            workState.pendingClients = [];
            fillSelect(workPendingClientSelectEl, [], () => "", () => "", "Select client from inbound");
            if (!workPendingInboundSelectEl?.value) {
                return;
            }
            try {
                await loadPendingInboundClients(workPendingInboundSelectEl.value);
            } catch (err) {
                console.error("load pending inbound clients error:", err);
            }
        });

        workPendingTelegramIdEl?.addEventListener("change", async () => {
            try {
                await loadPendingBindings(workPendingTelegramIdEl.value);
            } catch (err) {
                console.error("load pending bindings error:", err);
            }
        });

        workBindBtnEl?.addEventListener("click", async () => {
            await runWorkAction("Bind Client", async () => {
                const userId = workState.selectedUserId;
                if (!userId) {
                    throw new Error("Open client card first");
                }
                const { panelInboundId, inbound, client } = resolveInboundClientSelection(
                    workInboundSelectEl,
                    workClientSelectEl,
                    workState.clients,
                    "Select inbound and client"
                );

                const payload = {
                    user_id: Number(userId),
                    panel_inbound_id: panelInboundId,
                    client_identifier: client.identifier,
                    protocol: (inbound.protocol || client.protocol || "").toLowerCase(),
                    label: client.label,
                    secret: client.secret,
                    sub_id: client.sub_id,
                };

                const result = await postJson(adminBindClientUrl, payload);
                await loadSelectedUserBindings();
                await loadSelectedUserOverview();
                return result;
            });
        });

        workPendingAddBtnEl?.addEventListener("click", async () => {
            await runWorkAction("Add Pending Binding", async () => {
                const telegramId = String(workPendingTelegramIdEl?.value || "").trim();
                if (!telegramId || !/^\d+$/.test(telegramId)) {
                    throw new Error("Enter valid Telegram ID");
                }

                const { panelInboundId, inbound, client } = resolveInboundClientSelection(
                    workPendingInboundSelectEl,
                    workPendingClientSelectEl,
                    workState.pendingClients,
                    "Select inbound and client for pending"
                );

                const payload = {
                    telegram_id: telegramId,
                    panel_inbound_id: panelInboundId,
                    client_identifier: client.identifier,
                    protocol: (inbound.protocol || client.protocol || "").toLowerCase(),
                    label: client.label,
                    secret: client.secret,
                    sub_id: client.sub_id,
                };

                const result = await postJson(adminPendingBindingsUrl, payload);
                await loadPendingBindings(telegramId);
                return result;
            });
        });

        workSubSaveBtnEl?.addEventListener("click", async () => {
            await runWorkAction("Save Subscription", async () => {
                if (!workState.selectedUserId) {
                    throw new Error("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞");
                }

                const creatingSubscription = !workState.overview?.subscription;
                const selectedStatus = normalizeSubscriptionStatus(workSubStatusSelectEl?.value || "active");
                const payload = {
                    status: selectedStatus || "active",
                    price_amount: workSubPriceInputEl?.value?.trim() || null,
                    connections_limit: workSubLimitInputEl?.value?.trim() || null,
                };
                if (selectedStatus === "lifetime") {
                    payload.access_until = null;
                } else if (creatingSubscription) {
                    payload.access_until = validateSubscriptionDateValue(workSubCreateDateEl?.value);
                }
                const result = await postJson(adminUserSubscriptionUrl(workState.selectedUserId), payload);
                renderWorkClientOverview(result?.overview || null);
                return result;
            });
        });

        workSubExtendBtnEl?.addEventListener("click", async () => {
            await runWorkAction("Extend Subscription", async () => {
                if (!workState.selectedUserId) {
                    throw new Error("–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞");
                }
                const hasSubscription = Boolean(workState.overview?.subscription);
                if (!hasSubscription) {
                    const selectedStatus = normalizeSubscriptionStatus(workSubStatusSelectEl?.value || "active");
                    const payload =
                        selectedStatus === "lifetime"
                            ? { status: "lifetime", access_until: null }
                            : {
                                  status: "active",
                                  access_until: validateSubscriptionDateValue(workSubCreateDateEl?.value),
                              };
                    const result = await postJson(adminUserSubscriptionUrl(workState.selectedUserId), payload);
                    renderWorkClientOverview(result?.overview || null);
                    return result;
                }
                if (isSubscriptionLifetime(workState.overview?.subscription)) {
                    throw new Error("–ë–µ—Å—Å—Ä–æ—á–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å");
                }
                const months = Number(workSubExtendRangeEl?.value || 0);
                if (!Number.isInteger(months) || months <= 0) {
                    throw new Error("–í—ã–±–µ—Ä–∏ —Å—Ä–æ–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏—è");
                }
                const result = await postJson(adminUserSubscriptionUrl(workState.selectedUserId), {
                    extend_months: months,
                });
                renderWorkClientOverview(result?.overview || null);
                return result;
            });
        });

        workSubExtendRangeEl?.addEventListener("input", () => {
            renderWorkSubExtendValue();
        });
        workSubStatusSelectEl?.addEventListener("change", () => {
            renderWorkSubscriptionControls(workState.overview?.subscription || null);
        });
        renderWorkSubExtendValue();
        updateCloudPageContext(cloudState.path);
        updateCloudUpButton();
    </script>
</body>
</html>


